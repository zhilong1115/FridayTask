<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>2026-02-22 - å›æµ‹é™·é˜±ï¼šOverfittingã€Look-ahead Biasã€Survivorship Bias</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.8; color: #333; }
    .bilingual { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .zh { border-left: 3px solid #c41e3a; padding-left: 15px; }
    .en { border-left: 3px solid #1a73e8; padding-left: 15px; }
    h1 { color: #2c3e50; border-bottom: 2px solid #e74c3c; padding-bottom: 10px; }
    h2 { color: #c0392b; margin-top: 30px; }
    h3 { color: #2980b9; }
    .formula { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; font-family: 'Courier New', monospace; line-height: 2; }
    .code { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; overflow-x: auto; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.5; white-space: pre; }
    .insight { background: #eaf2f8; padding: 15px; border-radius: 8px; margin: 20px 0; }
    .references { background: #f8f9fa; padding: 15px; border-radius: 8px; }
    .warning { background: #fdecea; padding: 15px; border-radius: 8px; border-left: 4px solid #e74c3c; margin: 15px 0; }
    .example { background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0; }
    table { border-collapse: collapse; width: 100%; margin: 15px 0; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #f5f5f5; }
    .day-badge { background: #e74c3c; color: white; padding: 5px 15px; border-radius: 20px; display: inline-block; margin-bottom: 15px; }
  </style>
</head>
<body>
  <span class="day-badge">ğŸ“ˆ Day 7 | Phase 1 Foundations å®Œç»“ç¯‡</span>
  <h1>å›æµ‹é™·é˜± â€” Overfittingã€Look-ahead Biasã€Survivorship Bias</h1>
  <h1>Backtesting Pitfalls â€” The Three Deadly Sins of Quant</h1>

  <div class="warning">
    <strong>âš ï¸ æ ¸å¿ƒè­¦å‘Š / Core Warning:</strong> ä¸€ä¸ªåœ¨å›æµ‹ä¸­å¹´åŒ–æ”¶ç›Š100%çš„ç­–ç•¥ï¼Œä¸Šçº¿åå¯èƒ½äºæŸã€‚é—®é¢˜å¾€å¾€ä¸åœ¨ç­–ç•¥æœ¬èº«ï¼Œè€Œåœ¨å›æµ‹è¿‡ç¨‹ä¸­çš„ç³»ç»Ÿæ€§åå·®ã€‚ä»Šå¤©çš„å†…å®¹å¯èƒ½æ˜¯æ•´ä¸ªè¯¾ç¨‹ä¸­æœ€é‡è¦çš„ä¸€è¯¾â€”â€”å› ä¸ºå®ƒå†³å®šäº†ä½ çš„å…¶ä»–æ‰€æœ‰çŸ¥è¯†æ˜¯å¦èƒ½çœŸæ­£è½¬åŒ–ä¸ºå®ç›˜åˆ©æ¶¦ã€‚<br><br>
    A strategy showing 100% annualized returns in backtest might lose money live. The problem is often not the strategy itself, but systematic biases in the backtesting process. Today's lesson may be the most important in the entire curriculum â€” it determines whether all your other knowledge can actually translate into live profits.
  </div>

  <!-- ==================== 1. Overfitting ==================== -->
  <h2>ä¸€ã€è¿‡æ‹Ÿåˆ / Overfitting</h2>

  <div class="bilingual">
    <div class="zh">
      <h3>ä»€ä¹ˆæ˜¯è¿‡æ‹Ÿåˆï¼Ÿ</h3>
      <p>è¿‡æ‹Ÿåˆæ˜¯æŒ‡ç­–ç•¥è¿‡åº¦æ‹Ÿåˆäº†å†å²æ•°æ®ä¸­çš„<strong>å™ªå£°</strong>è€Œé<strong>ä¿¡å·</strong>ã€‚å°±åƒä¸€ä¸ªå­¦ç”ŸèƒŒä¸‹äº†æ‰€æœ‰å†å¹´è¯•é¢˜çš„ç­”æ¡ˆï¼Œä½†å®Œå…¨ä¸ç†è§£åŸç†â€”â€”æ¢ä¸€å¥—æ–°é¢˜å°±å…¨éƒ¨ç­”é”™ã€‚</p>
      <p>åœ¨é‡åŒ–äº¤æ˜“ä¸­ï¼Œè¿‡æ‹Ÿåˆè¡¨ç°ä¸ºï¼š</p>
      <ul>
        <li>å‚æ•°æ•°é‡è¿‡å¤šï¼ˆè‡ªç”±åº¦è¿‡é«˜ï¼‰</li>
        <li>åœ¨æ ·æœ¬å†…ï¼ˆIn-Sampleï¼‰è¡¨ç°æä½³ï¼Œæ ·æœ¬å¤–ï¼ˆOut-of-Sampleï¼‰è¡¨ç°ç³Ÿç³•</li>
        <li>ç­–ç•¥é€»è¾‘ç¼ºä¹ç»æµå­¦ç›´è§‰æ”¯æ’‘</li>
        <li>è¿‡åº¦ä¼˜åŒ–å‚æ•°ï¼ˆå¦‚ SMA å‘¨æœŸç²¾ç¡®åˆ°17.3å¤©ï¼‰</li>
      </ul>
    </div>
    <div class="en">
      <h3>What is Overfitting?</h3>
      <p>Overfitting occurs when a strategy fits the <strong>noise</strong> in historical data rather than the <strong>signal</strong>. Like a student who memorizes all past exam answers without understanding principles â€” they fail on any new exam.</p>
      <p>In quant trading, overfitting manifests as:</p>
      <ul>
        <li>Too many parameters (excessive degrees of freedom)</li>
        <li>Excellent in-sample performance, terrible out-of-sample</li>
        <li>Strategy logic lacks economic intuition</li>
        <li>Over-optimized parameters (e.g., SMA period of exactly 17.3 days)</li>
      </ul>
    </div>
  </div>

  <h3>ğŸ“ è¿‡æ‹Ÿåˆçš„æ•°å­¦åº¦é‡ / Mathematical Measurement</h3>

  <div class="formula">
    <strong>Deflated Sharpe Ratio (Bailey & LÃ³pez de Prado, 2014):</strong><br><br>
    ç»™å®š N æ¬¡ç‹¬ç«‹å›æµ‹è¯•éªŒï¼Œè§‚æµ‹åˆ°çš„æœ€å¤§ Sharpe Ratio çš„æœŸæœ›å€¼ä¸ºï¼š<br><br>
    E[max(SR)] â‰ˆ âˆš(2 Â· ln(N))<br><br>
    å…¶ä¸­ N = è¯•éªŒæ¬¡æ•°ã€‚è¿™æ„å‘³ç€ï¼š<br>
    &nbsp;&nbsp;N = 10 æ¬¡è¯•éªŒ â†’ E[max(SR)] â‰ˆ 2.15<br>
    &nbsp;&nbsp;N = 100 æ¬¡è¯•éªŒ â†’ E[max(SR)] â‰ˆ 3.03<br>
    &nbsp;&nbsp;N = 1000 æ¬¡è¯•éªŒ â†’ E[max(SR)] â‰ˆ 3.72<br><br>
    å³ä½¿åº•å±‚ç­–ç•¥å®Œå…¨æ— æ•ˆï¼ˆçœŸå® SR=0ï¼‰ï¼Œå¤§é‡è¯•éªŒä¹Ÿä¼šäº§ç”Ÿçœ‹èµ·æ¥å¾ˆå¥½çš„ SRï¼<br><br>
    <strong>Probability of Backtest Overfitting (PBO):</strong><br>
    PBO = P(OOS rank of IS-optimal â‰¤ median)<br><br>
    é€šè¿‡ CSCVï¼ˆç»„åˆå¯¹ç§°äº¤å‰éªŒè¯ï¼‰ä¼°è®¡ï¼šå°†æ•°æ®åˆ†æˆ S ä¸ªå­é›†ï¼Œ<br>
    ç©·ä¸¾æ‰€æœ‰ C(S, S/2) ç§è®­ç»ƒ/æµ‹è¯•ç»„åˆï¼Œè®¡ç®— IS æœ€ä¼˜ç­–ç•¥åœ¨ OOS çš„æ’åæ¯”ä¾‹ã€‚<br>
    PBO > 0.5 â†’ å›æµ‹å¾ˆå¯èƒ½è¿‡æ‹Ÿåˆã€‚
  </div>

  <div class="insight">
    <strong>ğŸ’¡ LÃ³pez de Prado çš„è­¦å‘Šï¼š</strong>"å¤§å¤šæ•°å‘è¡¨åœ¨é‡‘èæœŸåˆŠä¸Šçš„å›æµ‹ç ”ç©¶ç»“æœéƒ½æ˜¯è¿‡æ‹Ÿåˆçš„äº§ç‰©ã€‚å¦‚æœä¸€ä¸ªåŸºé‡‘ç»ç†å°è¯•äº†1000ç§ç­–ç•¥å˜ä½“åå‘ä½ å±•ç¤ºé‚£ä¸ªæœ€å¥½çš„ï¼Œä½ çœ‹åˆ°çš„ä¸æ˜¯alphaï¼Œè€Œæ˜¯è¿æ°”ã€‚" â€” <em>Advances in Financial Machine Learning</em> (2018)
  </div>

  <!-- ==================== 2. Look-ahead Bias ==================== -->
  <h2>äºŒã€å‰è§†åå·® / Look-ahead Bias</h2>

  <div class="bilingual">
    <div class="zh">
      <h3>ä»€ä¹ˆæ˜¯å‰è§†åå·®ï¼Ÿ</h3>
      <p>å‰è§†åå·®æ˜¯æŒ‡åœ¨å›æµ‹ä¸­ä½¿ç”¨äº†<strong>å½“æ—¶ä¸å¯èƒ½è·å¾—çš„æœªæ¥ä¿¡æ¯</strong>æ¥åšäº¤æ˜“å†³ç­–ã€‚è¿™æ˜¯æœ€éšè”½ä¹Ÿæœ€å±é™©çš„åå·®ä¹‹ä¸€ã€‚</p>
      <p><strong>å¸¸è§å½¢å¼ï¼š</strong></p>
      <ul>
        <li><strong>æ•°æ®æ³„æ¼</strong>ï¼šç”¨æ”¶ç›˜ä»·è®¡ç®—ä¿¡å·ï¼Œå´åœ¨å½“æ—¥æ”¶ç›˜å‰ä¸‹å•</li>
        <li><strong>å¤æƒé™·é˜±</strong>ï¼šä½¿ç”¨åå¤æƒä»·æ ¼ï¼Œä½†è¿™äº›æ•°æ®åœ¨å½“æ—¶å¹¶ä¸å­˜åœ¨ï¼ˆæ‹†è‚¡/åˆ†çº¢å°šæœªå‘ç”Ÿï¼‰</li>
        <li><strong>è´¢æŠ¥æ—¥æœŸ</strong>ï¼šä½¿ç”¨äº†æŠ¥å‘ŠæœŸçš„è´¢åŠ¡æ•°æ®ï¼Œä½†è¯¥æ•°æ®å®é™…åœ¨å‡ å‘¨åæ‰å…¬å¸ƒ</li>
        <li><strong>æŒ‡æ•°æˆåˆ†</strong>ï¼šç”¨å½“å‰çš„ S&P 500 æˆåˆ†è‚¡å›æµ‹å†å²ç­–ç•¥ï¼ˆå½“æ—¶æŸäº›è‚¡ç¥¨è¿˜æœªè¢«çº³å…¥ï¼‰</li>
        <li><strong>ç‰¹å¾å·¥ç¨‹</strong>ï¼šå¯¹æ•´ä¸ªæ•°æ®é›†åšå½’ä¸€åŒ–/æ ‡å‡†åŒ–ï¼Œè€Œéä»…ç”¨å†å²æ•°æ®</li>
      </ul>
    </div>
    <div class="en">
      <h3>What is Look-ahead Bias?</h3>
      <p>Look-ahead bias occurs when a backtest uses <strong>future information that would not have been available</strong> at the time of the trading decision. It's one of the most insidious and dangerous biases.</p>
      <p><strong>Common forms:</strong></p>
      <ul>
        <li><strong>Data leakage</strong>: Computing signals with close prices but executing before close</li>
        <li><strong>Adjustment trap</strong>: Using adjusted prices that weren't available yet (splits/dividends hadn't occurred)</li>
        <li><strong>Earnings dates</strong>: Using financial data from report period, but it was published weeks later</li>
        <li><strong>Index composition</strong>: Backtesting with current S&P 500 members (some weren't included historically)</li>
        <li><strong>Feature engineering</strong>: Normalizing over the entire dataset instead of only historical data</li>
      </ul>
    </div>
  </div>

  <div class="warning">
    <strong>ğŸ”¥ çœŸå®æ¡ˆä¾‹ / Real Example:</strong><br>
    å‡è®¾ä½ åœ¨2020å¹´1æœˆå›æµ‹ä¸€ä¸ªåŸºäº P/E Ratio çš„é€‰è‚¡ç­–ç•¥ã€‚ä½ ä»æ•°æ®åº“è·å–2019å¹´Q4çš„æ¯è‚¡æ”¶ç›Šï¼ˆEPSï¼‰ã€‚ä½†å®é™…ä¸Šï¼Œå¤§éƒ¨åˆ†å…¬å¸çš„Q4è´¢æŠ¥ç›´åˆ°2020å¹´2æœˆ-3æœˆæ‰å‘å¸ƒï¼ä½ çš„å›æµ‹åœ¨2020å¹´1æœˆå°±ä½¿ç”¨äº†2æœˆæ‰å…¬å¸ƒçš„æ•°æ®ã€‚<br><br>
    Point-in-time (PIT) æ•°æ®åº“é€šè¿‡è®°å½•æ•°æ®çš„<strong>å‘å¸ƒæ—¥æœŸ</strong>ï¼ˆè€ŒéæŠ¥å‘ŠæœŸï¼‰æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚
  </div>

  <!-- ==================== 3. Survivorship Bias ==================== -->
  <h2>ä¸‰ã€å¹¸å­˜è€…åå·® / Survivorship Bias</h2>

  <div class="bilingual">
    <div class="zh">
      <h3>ä»€ä¹ˆæ˜¯å¹¸å­˜è€…åå·®ï¼Ÿ</h3>
      <p>å¹¸å­˜è€…åå·®æ˜¯æŒ‡å›æµ‹æ•°æ®é›†ä¸­<strong>åªåŒ…å«è‡³ä»Šä»ç„¶å­˜æ´»çš„è¯åˆ¸</strong>ï¼Œè€Œæ’é™¤äº†å·²é€€å¸‚ã€ç ´äº§ã€è¢«æ”¶è´­çš„è¯åˆ¸ã€‚è¿™ä¼šç³»ç»Ÿæ€§åœ°é«˜ä¼°ç­–ç•¥è¡¨ç°ã€‚</p>
      <p><strong>å½±å“æœ‰å¤šå¤§ï¼Ÿ</strong></p>
      <ul>
        <li>ç ”ç©¶æ˜¾ç¤ºï¼Œå¹¸å­˜è€…åå·®å¯ä½¿å¹´åŒ–æ”¶ç›Šç‡è™šå¢ <strong>1-2%</strong></li>
        <li>1926-2019å¹´é—´ï¼Œç¾è‚¡çº¦æœ‰ <strong>40%</strong> çš„è‚¡ç¥¨æœ€ç»ˆé€€å¸‚</li>
        <li>è®¸å¤šé€€å¸‚è‚¡ç¥¨çš„æ”¶ç›Šç‡ä¸º <strong>-100%</strong>ï¼ˆç ´äº§æ¸…é›¶ï¼‰</li>
        <li>å°å¸‚å€¼è‚¡ç¥¨çš„å¹¸å­˜è€…åå·®æ›´ä¸ºä¸¥é‡</li>
      </ul>
    </div>
    <div class="en">
      <h3>What is Survivorship Bias?</h3>
      <p>Survivorship bias occurs when the backtest dataset <strong>only includes securities that still exist today</strong>, excluding those that were delisted, went bankrupt, or were acquired. This systematically overstates strategy performance.</p>
      <p><strong>How significant is it?</strong></p>
      <ul>
        <li>Studies show survivorship bias can inflate annual returns by <strong>1-2%</strong></li>
        <li>Between 1926-2019, about <strong>40%</strong> of US stocks eventually delisted</li>
        <li>Many delisted stocks had returns of <strong>-100%</strong> (bankruptcy)</li>
        <li>Small-cap stocks suffer more severe survivorship bias</li>
      </ul>
    </div>
  </div>

  <div class="example">
    <strong>ğŸ“Š ç»å…¸ä¾‹å­ / Classic Example:</strong><br>
    ä½ åœ¨2025å¹´è·å–äº†"å½“å‰ S&P 500 æˆåˆ†è‚¡"çš„å†å²æ•°æ®ï¼Œå›æµ‹2010-2025å¹´çš„åŠ¨é‡ç­–ç•¥ã€‚é—®é¢˜æ˜¯ï¼š2010å¹´æ—¶ S&P 500 çš„æˆåˆ†å®Œå…¨ä¸åŒï¼é‚£äº›åœ¨è¿™15å¹´é—´å› ä¸šç»©ä¸ä½³è¢«è¸¢å‡ºçš„å…¬å¸ï¼Œä½ å…¨éƒ½æ²¡æœ‰çº³å…¥æµ‹è¯•ã€‚ä½ çš„ç­–ç•¥æœ¬è´¨ä¸Šåœ¨"å·çœ‹æœªæ¥"â€”â€”åªæŒ‘é€‰äº†æœ€ç»ˆå­˜æ´»ä¸‹æ¥çš„èµ¢å®¶ã€‚
  </div>

  <!-- ==================== 4. å…¶ä»–å¸¸è§åå·® ==================== -->
  <h2>å››ã€å…¶ä»–å¸¸è§åå·® / Other Common Biases</h2>

  <table>
    <tr>
      <th>åå·® / Bias</th>
      <th>æè¿° / Description</th>
      <th>è§£å†³æ–¹æ¡ˆ / Solution</th>
    </tr>
    <tr>
      <td><strong>Data-Snooping Bias</strong><br>æ•°æ®çª¥æ¢åå·®</td>
      <td>åå¤åœ¨åŒä¸€æ•°æ®é›†ä¸Šæµ‹è¯•ä¸åŒç­–ç•¥ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ª"æœ‰æ•ˆ"çš„</td>
      <td>ä¿ç•™ holdout æ•°æ®é›†ï¼›ä½¿ç”¨ Bonferroni æ ¡æ­£æˆ– Deflated Sharpe Ratio</td>
    </tr>
    <tr>
      <td><strong>Transaction Cost Bias</strong><br>äº¤æ˜“æˆæœ¬åå·®</td>
      <td>å¿½ç•¥æ‰‹ç»­è´¹ã€æ»‘ç‚¹ã€å¸‚åœºå†²å‡»</td>
      <td>åŠ å…¥çœŸå®çš„äº¤æ˜“æˆæœ¬æ¨¡å‹ï¼›é«˜é¢‘ç­–ç•¥å°¤å…¶æ•æ„Ÿ</td>
    </tr>
    <tr>
      <td><strong>Selection Bias</strong><br>é€‰æ‹©åå·®</td>
      <td>åªå‘è¡¨/å±•ç¤ºè¡¨ç°å¥½çš„ç­–ç•¥</td>
      <td>è®°å½•æ‰€æœ‰å°è¯•è¿‡çš„ç­–ç•¥ï¼ˆç­–ç•¥æ—¥å¿—ï¼‰</td>
    </tr>
    <tr>
      <td><strong>Regime Change Bias</strong><br>å¸‚åœºç¯å¢ƒåå·®</td>
      <td>ç­–ç•¥åœ¨ç‰¹å®šå¸‚åœºç¯å¢ƒä¸‹æœ‰æ•ˆï¼Œä½†ç¯å¢ƒå·²æ”¹å˜</td>
      <td>åˆ†æ—¶æœŸå›æµ‹ï¼›å‹åŠ›æµ‹è¯•ä¸åŒå¸‚åœºç¯å¢ƒ</td>
    </tr>
  </table>

  <!-- ==================== 5. é˜²å¾¡æ¡†æ¶ ==================== -->
  <h2>äº”ã€é˜²å¾¡æ¡†æ¶ / Defense Framework</h2>

  <div class="bilingual">
    <div class="zh">
      <h3>ç³»ç»ŸåŒ–é˜²å¾¡æ£€æŸ¥æ¸…å•</h3>
      <ol>
        <li><strong>ç»æµç›´è§‰</strong>ï¼šç­–ç•¥èƒŒåæœ‰åˆç†çš„ç»æµå­¦è§£é‡Šå—ï¼Ÿ</li>
        <li><strong>å‚æ•°ç¨³å¥æ€§</strong>ï¼šå¾®è°ƒå‚æ•°åç­–ç•¥è¿˜èƒ½å·¥ä½œå—ï¼Ÿï¼ˆå‚æ•°å¹³åŸ vs å‚æ•°å°–å³°ï¼‰</li>
        <li><strong>æ ·æœ¬å¤–æµ‹è¯•</strong>ï¼šä¸¥æ ¼åˆ†ç¦» IS/OOSï¼Œç”¨ walk-forward åˆ†æ</li>
        <li><strong>è·¨å¸‚åœºæµ‹è¯•</strong>ï¼šç­–ç•¥åœ¨å…¶ä»–å¸‚åœº/èµ„äº§ç±»åˆ«æœ‰æ•ˆå—ï¼Ÿ</li>
        <li><strong>å¤šé‡å‡è®¾æ ¡æ­£</strong>ï¼šç”¨ Deflated SR æˆ– PBO é‡åŒ–è¿‡æ‹Ÿåˆæ¦‚ç‡</li>
        <li><strong>ç®€æ´æ€§</strong>ï¼šå¥¥å¡å§†å‰ƒåˆ€â€”â€”å‚æ•°è¶Šå°‘è¶Šå¥½</li>
        <li><strong>Point-in-time æ•°æ®</strong>ï¼šç¡®ä¿æ²¡æœ‰å‰è§†åå·®</li>
        <li><strong>Survivorship-free æ•°æ®</strong>ï¼šä½¿ç”¨åŒ…å«é€€å¸‚è‚¡ç¥¨çš„æ•°æ®é›†</li>
      </ol>
    </div>
    <div class="en">
      <h3>Systematic Defense Checklist</h3>
      <ol>
        <li><strong>Economic intuition</strong>: Does the strategy have a sound economic rationale?</li>
        <li><strong>Parameter robustness</strong>: Does it still work with slightly different parameters? (plateau vs spike)</li>
        <li><strong>Out-of-sample testing</strong>: Strict IS/OOS separation, walk-forward analysis</li>
        <li><strong>Cross-market testing</strong>: Does it work on other markets/asset classes?</li>
        <li><strong>Multiple hypothesis correction</strong>: Use Deflated SR or PBO to quantify overfitting</li>
        <li><strong>Simplicity</strong>: Occam's Razor â€” fewer parameters is better</li>
        <li><strong>Point-in-time data</strong>: Ensure no look-ahead bias</li>
        <li><strong>Survivorship-free data</strong>: Use datasets that include delisted stocks</li>
      </ol>
    </div>
  </div>

  <!-- ==================== 6. ä»£ç ç¤ºä¾‹ ==================== -->
  <h2>å…­ã€ä»£ç ç¤ºä¾‹ / Code Examples</h2>

  <h3>6.1 Walk-Forward Validation æ»šåŠ¨å‰å‘éªŒè¯</h3>

  <div class="code">import numpy as np
import pandas as pd
from itertools import combinations

def walk_forward_validation(returns, strategy_func, 
                            train_window=252, test_window=63):
    """
    Walk-forward analysis: train on rolling window, test on next period.
    æ»šåŠ¨å‰å‘éªŒè¯ï¼šåœ¨æ»šåŠ¨çª—å£ä¸Šè®­ç»ƒï¼Œåœ¨ä¸‹ä¸€æ—¶æ®µæµ‹è¯•ã€‚
    
    Args:
        returns: pd.Series of daily returns
        strategy_func: function(train_data) -> optimal_params
        train_window: training period in days (default 1 year)
        test_window: testing period in days (default 1 quarter)
    """
    results = []
    
    for start in range(0, len(returns) - train_window - test_window, test_window):
        # Strict separation: train and test never overlap
        train_data = returns.iloc[start:start + train_window]
        test_data = returns.iloc[start + train_window:
                                  start + train_window + test_window]
        
        # Optimize on training data ONLY
        optimal_params = strategy_func(train_data)
        
        # Evaluate on unseen test data
        test_return = apply_strategy(test_data, optimal_params)
        
        results.append({
            'train_start': train_data.index[0],
            'test_start': test_data.index[0],
            'test_end': test_data.index[-1],
            'train_sharpe': sharpe_ratio(train_data),
            'test_sharpe': sharpe_ratio(test_return),
            'params': optimal_params
        })
    
    df = pd.DataFrame(results)
    
    # KEY METRIC: correlation between IS and OOS performance
    # å…³é”®æŒ‡æ ‡ï¼šæ ·æœ¬å†…ä¸æ ·æœ¬å¤–è¡¨ç°çš„ç›¸å…³æ€§
    correlation = df['train_sharpe'].corr(df['test_sharpe'])
    print(f"IS-OOS Sharpe Correlation: {correlation:.3f}")
    print(f"Mean IS Sharpe:  {df['train_sharpe'].mean():.3f}")
    print(f"Mean OOS Sharpe: {df['test_sharpe'].mean():.3f}")
    # If OOS Sharpe << IS Sharpe â†’ likely overfitting!
    
    return df</div>

  <h3>6.2 Deflated Sharpe Ratio è°ƒæ•´åçš„å¤æ™®æ¯”ç‡</h3>

  <div class="code">from scipy.stats import norm

def deflated_sharpe_ratio(observed_sr, sr_std, n_trials, T, 
                          skew=0, kurtosis=3):
    """
    Bailey & LÃ³pez de Prado (2014): Deflated Sharpe Ratio.
    Tests whether observed SR is significant after accounting 
    for multiple testing.
    
    è€ƒè™‘å¤šé‡æµ‹è¯•åï¼Œè§‚æµ‹åˆ°çš„ SR æ˜¯å¦ä»ç„¶æ˜¾è‘—ã€‚
    
    Args:
        observed_sr: Best Sharpe ratio found (è§‚æµ‹åˆ°çš„æœ€ä½³SR)
        sr_std: Std of SR estimates across trials (SRçš„æ ‡å‡†å·®)
        n_trials: Number of strategy variations tried (å°è¯•çš„ç­–ç•¥æ•°)
        T: Number of return observations (æ”¶ç›Šç‡è§‚æµ‹æ•°)
        skew: Skewness of returns (æ”¶ç›Šç‡ååº¦)
        kurtosis: Kurtosis of returns (æ”¶ç›Šç‡å³°åº¦)
    """
    # Expected maximum SR under null hypothesis (H0: true SR = 0)
    # é›¶å‡è®¾ä¸‹çš„æœŸæœ›æœ€å¤§SRï¼ˆçœŸå®SRä¸º0æ—¶ï¼‰
    euler_mascheroni = 0.5772156649
    expected_max_sr = ((1 - euler_mascheroni) * norm.ppf(1 - 1/n_trials) 
                       + euler_mascheroni * norm.ppf(1 - 1/(n_trials * np.e)))
    
    # Standard error of SR estimate
    # SRä¼°è®¡çš„æ ‡å‡†è¯¯å·®
    sr_se = np.sqrt((1 - skew * observed_sr 
                     + (kurtosis - 1)/4 * observed_sr**2) / T)
    
    # Deflated SR: z-score against expected max
    # è°ƒæ•´åSRï¼šç›¸å¯¹äºæœŸæœ›æœ€å¤§å€¼çš„zåˆ†æ•°
    dsr = (observed_sr - expected_max_sr * sr_std) / sr_se
    p_value = 1 - norm.cdf(dsr)
    
    print(f"Observed SR:     {observed_sr:.3f}")
    print(f"Expected Max SR: {expected_max_sr:.3f} (from {n_trials} trials)")
    print(f"Deflated SR:     {dsr:.3f}")
    print(f"P-value:         {p_value:.4f}")
    print(f"Significant (5%): {'YES âœ…' if p_value < 0.05 else 'NO âŒ'}")
    
    return dsr, p_value

# Example: You tried 100 strategy variations and found SR = 2.0
# ä¾‹ï¼šå°è¯•äº†100ç§ç­–ç•¥å˜ä½“ï¼Œæ‰¾åˆ°äº†SR=2.0çš„ç­–ç•¥
dsr, pval = deflated_sharpe_ratio(
    observed_sr=2.0,   # Looks great! çœ‹èµ·æ¥å¾ˆæ£’ï¼
    sr_std=0.5,        # Variation across trials
    n_trials=100,      # But you tried 100 times... ä½†ä½ è¯•äº†100æ¬¡...
    T=252 * 5          # 5 years of daily data
)
# Result: Probably NOT significant after correction!
# ç»“æœï¼šæ ¡æ­£åå¾ˆå¯èƒ½ä¸æ˜¾è‘—ï¼</div>

  <h3>6.3 æ£€æµ‹å‰è§†åå·® / Detecting Look-ahead Bias</h3>

  <div class="code">def check_look_ahead_bias(signals, prices):
    """
    Simple check: signals should only use data available at signal time.
    ç®€å•æ£€æµ‹ï¼šä¿¡å·åªåº”ä½¿ç”¨ä¿¡å·ç”Ÿæˆæ—¶åˆ»å¯ç”¨çš„æ•°æ®ã€‚
    
    Red flags (å±é™©ä¿¡å·):
    1. Signal at time t uses price at time t (close) but trades at t
    2. Signal correlates with FUTURE returns better than past
    """
    # Test 1: Can you trade BEFORE the signal is fully formed?
    # æ£€æµ‹1ï¼šä½ èƒ½åœ¨ä¿¡å·å®Œå…¨å½¢æˆä¹‹å‰äº¤æ˜“å—ï¼Ÿ
    for t in range(len(signals)):
        signal_inputs = get_data_used_by_signal(signals, t)
        latest_timestamp = max(signal_inputs.index)
        trade_timestamp = signals.index[t]
        
        if latest_timestamp >= trade_timestamp:
            print(f"âš ï¸ LOOK-AHEAD at {trade_timestamp}: "
                  f"signal uses data from {latest_timestamp}")
    
    # Test 2: Information coefficient with future vs past returns
    # æ£€æµ‹2ï¼šä¿¡å·ä¸æœªæ¥/è¿‡å»æ”¶ç›Šçš„ä¿¡æ¯ç³»æ•°
    future_returns = prices.pct_change().shift(-1)  # Next day return
    past_returns = prices.pct_change()               # Current day return
    
    ic_future = signals.corr(future_returns)
    ic_past = signals.corr(past_returns)
    
    print(f"IC with future returns: {ic_future:.4f}")
    print(f"IC with past returns:   {ic_past:.4f}")
    
    # If IC_future >> IC_past â†’ suspicious look-ahead!
    if abs(ic_future) > 2 * abs(ic_past):
        print("ğŸš¨ WARNING: Suspiciously high future IC - check for look-ahead bias!")</div>

  <h3>6.4 Survivorship-free å›æµ‹ç¤ºä¾‹</h3>

  <div class="code">def survivorship_free_universe(date, full_listing_data):
    """
    Build point-in-time stock universe, including delisted stocks.
    æ„å»ºæ—¶ç‚¹æ€§è‚¡ç¥¨æ± ï¼ŒåŒ…å«å·²é€€å¸‚è‚¡ç¥¨ã€‚
    
    Args:
        date: The date for which to build the universe
        full_listing_data: DataFrame with columns:
            - ticker, listing_date, delisting_date, delisting_return
    """
    # Only include stocks that were ACTIVE on this date
    # åªåŒ…å«è¯¥æ—¥æœŸæ—¶å¤„äºæ´»è·ƒçŠ¶æ€çš„è‚¡ç¥¨
    universe = full_listing_data[
        (full_listing_data['listing_date'] <= date) &
        ((full_listing_data['delisting_date'] >= date) | 
         (full_listing_data['delisting_date'].isna()))  # Still active
    ]
    
    return universe['ticker'].tolist()

# Survivorship bias impact simulation
# å¹¸å­˜è€…åå·®å½±å“æ¨¡æ‹Ÿ
def simulate_survivorship_impact(n_stocks=500, n_years=10, 
                                 annual_delist_rate=0.05,
                                 delist_avg_return=-0.30):
    """
    Simulate how much survivorship bias inflates returns.
    æ¨¡æ‹Ÿå¹¸å­˜è€…åå·®å¯¹æ”¶ç›Šçš„è™šå¢ç¨‹åº¦ã€‚
    """
    np.random.seed(42)
    n_days = n_years * 252
    
    # Generate returns for ALL stocks (survivors + non-survivors)
    all_returns = np.random.normal(0.0003, 0.02, (n_days, n_stocks))
    
    # Randomly delist some stocks (with negative final returns)
    n_delisted = int(n_stocks * annual_delist_rate * n_years)
    delist_indices = np.random.choice(n_stocks, n_delisted, replace=False)
    delist_days = np.random.randint(0, n_days, n_delisted)
    
    for idx, day in zip(delist_indices, delist_days):
        all_returns[day, idx] = delist_avg_return  # Delisting shock
        all_returns[day+1:, idx] = 0  # No more returns
    
    # Portfolio with ALL stocks (correct)
    all_portfolio = np.mean(all_returns, axis=1)
    
    # Portfolio with SURVIVORS only (biased)
    survivors = [i for i in range(n_stocks) if i not in delist_indices]
    survivor_portfolio = np.mean(all_returns[:, survivors], axis=1)
    
    bias = (np.mean(survivor_portfolio) - np.mean(all_portfolio)) * 252
    print(f"Annual return (all stocks):  {np.mean(all_portfolio)*252:.2%}")
    print(f"Annual return (survivors):   {np.mean(survivor_portfolio)*252:.2%}")
    print(f"Survivorship bias:           {bias:.2%} per year")
    
    return bias

simulate_survivorship_impact()</div>

  <!-- ==================== 7. References ==================== -->
  <h2>ä¸ƒã€å‚è€ƒæ–‡çŒ® / References</h2>

  <div class="references">
    <ol>
      <li>Bailey, D.H., Borwein, J., LÃ³pez de Prado, M., & Zhu, Q.J. (2015). <em>"The Probability of Backtest Overfitting."</em> Journal of Computational Finance. â€” æå‡ºäº† PBO å’Œ CSCV æ¡†æ¶</li>
      <li>Bailey, D.H. & LÃ³pez de Prado, M. (2014). <em>"The Deflated Sharpe Ratio."</em> Journal of Portfolio Management. â€” Deflated SR çš„åŸå§‹è®ºæ–‡</li>
      <li>LÃ³pez de Prado, M. (2018). <em>"Advances in Financial Machine Learning."</em> Wiley. Chapter 11-12. â€” å›æµ‹è¿‡æ‹Ÿåˆçš„ç³»ç»ŸåŒ–å¤„ç†</li>
      <li>Chan, E. (2008). <em>"Quantitative Trading."</em> Wiley. Chapter 3. â€” å›æµ‹é™·é˜±çš„å®è·µè€…è§†è§’</li>
      <li>Harvey, C.R., Liu, Y., & Zhu, H. (2016). <em>"... and the Cross-Section of Expected Returns."</em> Review of Financial Studies. â€” å‘ç°å¤§å¤šæ•°å·²å‘è¡¨çš„å› å­å¯èƒ½æ˜¯ data-snooping çš„äº§ç‰©</li>
      <li>Elton, E.J., Gruber, M.J., & Blake, C.R. (1996). <em>"Survivorship Bias and Mutual Fund Performance."</em> Review of Financial Studies. â€” å¹¸å­˜è€…åå·®å¯¹åŸºé‡‘è¯„ä¼°çš„å½±å“</li>
    </ol>
  </div>

  <!-- ==================== 8. Knowledge Graph ==================== -->
  <h2>å…«ã€çŸ¥è¯†ç½‘ç»œ / Knowledge Graph</h2>

  <div class="insight">
    <p><strong>ä¸å‰å‡ å¤©çš„è”ç³»ï¼š</strong></p>
    <ul>
      <li><strong>Day 2 (æ•°æ®åŸºç¡€)</strong> â†’ æ•°æ®è´¨é‡é—®é¢˜ç›´æ¥å¯¼è‡´å‰è§†åå·®å’Œå¹¸å­˜è€…åå·®ï¼›Adjusted Prices å¦‚æœä½¿ç”¨ä¸å½“å°±æ˜¯å‰è§†åå·®</li>
      <li><strong>Day 3 (æ”¶ç›Šç‡)</strong> â†’ æ”¶ç›Šç‡çš„è®¡ç®—æ–¹å¼ä¼šå½±å“å›æµ‹ç»“æœï¼›å¤åˆ©æ•ˆåº”åœ¨æœ‰åå·®çš„å›æµ‹ä¸­è¢«æ”¾å¤§</li>
      <li><strong>Day 4 (ç»Ÿè®¡/Fat Tails)</strong> â†’ è¿‡æ‹Ÿåˆçš„ç­–ç•¥å¾€å¾€å‡è®¾æ”¶ç›Šç‡æ˜¯æ­£æ€åˆ†å¸ƒçš„ï¼›å¿½ç•¥å°¾éƒ¨é£é™©</li>
      <li><strong>Day 5 (æ—¶é—´åºåˆ—)</strong> â†’ å¯¹éå¹³ç¨³åºåˆ—ç›´æ¥å»ºæ¨¡å®¹æ˜“è¿‡æ‹Ÿåˆï¼›ä¼ªå›å½’å°±æ˜¯ä¸€ç§è¿‡æ‹Ÿåˆ</li>
      <li><strong>Day 6 (å›æµ‹æ¡†æ¶)</strong> â†’ æ¡†æ¶æœ¬èº«ä¸èƒ½é˜²æ­¢åå·®ï¼›ä½ éœ€è¦æ­£ç¡®ä½¿ç”¨æ¡†æ¶</li>
    </ul>
    <p><strong>Phase 1 å®Œç»“ï¼š</strong>åŸºç¡€ç¯‡åˆ°æ­¤ç»“æŸã€‚ä½ ç°åœ¨æ‹¥æœ‰äº†é‡åŒ–äº¤æ˜“çš„"åŸºæœ¬åŠŸ"â€”â€”æ•°æ®ã€ç»Ÿè®¡ã€å›æµ‹ï¼Œä»¥åŠæœ€é‡è¦çš„ï¼šçŸ¥é“ä»€ä¹ˆä¼šå‡ºé”™ã€‚ä¸‹ä¸€é˜¶æ®µæˆ‘ä»¬å°†è¿›å…¥æŠ€æœ¯æŒ‡æ ‡çš„ä¸–ç•Œã€‚</p>
  </div>

  <!-- ==================== 9. Think About It ==================== -->
  <h2>ä¹ã€æ€è€ƒé¢˜ / Think About It</h2>

  <div class="insight">
    <p><strong>ğŸ’­ é—®é¢˜ï¼š</strong>ä½ å‘ç°äº†ä¸€ä¸ªåœ¨è¿‡å»10å¹´å›æµ‹ä¸­å¹´åŒ–æ”¶ç›Š30%ã€Sharpe 2.5 çš„ç­–ç•¥ã€‚ä½ åœ¨å¼€å‘è¿‡ç¨‹ä¸­æ€»å…±å°è¯•äº†çº¦200ç§å‚æ•°ç»„åˆã€‚è¯·é—®ï¼š</p>
    <ol>
      <li>ä½¿ç”¨ E[max(SR)] â‰ˆ âˆš(2Â·ln(N)) å…¬å¼ï¼Œè®¡ç®—åœ¨é›¶å‡è®¾ä¸‹ï¼ˆç­–ç•¥æ— æ•ˆï¼‰ä½ æœŸæœ›çœ‹åˆ°çš„æœ€å¤§ SR æ˜¯å¤šå°‘ï¼Ÿ</li>
      <li>ä½ çš„ç­–ç•¥é€šè¿‡äº† Deflated Sharpe Ratio æ£€éªŒå—ï¼Ÿ</li>
      <li>ä½ è¿˜éœ€è¦åšå“ªäº›é¢å¤–æ£€æŸ¥æ¥å¢å¼ºä¿¡å¿ƒï¼Ÿ</li>
    </ol>
    <p><strong>ğŸ’­ Question:</strong> You found a strategy with 30% annualized return and Sharpe 2.5 over 10 years of backtest. You tried about 200 parameter combinations during development.</p>
    <ol>
      <li>Using E[max(SR)] â‰ˆ âˆš(2Â·ln(N)), what's the expected maximum SR under the null hypothesis?</li>
      <li>Does your strategy pass the Deflated Sharpe Ratio test?</li>
      <li>What additional checks would you perform to build confidence?</li>
    </ol>
  </div>

</body>
</html>