<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2026-02-11 â€” è®¾è®¡æ¨èç³»ç»Ÿ (Netflix/YouTube)</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #fff; color: #1a1a1a; line-height: 1.7; }
    .bilingual { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .zh { border-left: 3px solid #f9ab00; padding-left: 15px; }
    .en { border-left: 3px solid #1a73e8; padding-left: 15px; }
    h1 { color: #3c4043; border-bottom: 2px solid #f9ab00; padding-bottom: 10px; }
    h2 { color: #1a73e8; margin-top: 35px; }
    h3 { color: #3c4043; }
    .architecture { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; font-family: 'Courier New', monospace; font-size: 13px; white-space: pre; overflow-x: auto; line-height: 1.4; }
    pre { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 13px; }
    code { font-family: 'Courier New', monospace; }
    .highlight { background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; }
    .highlight h4 { margin-top: 0; color: #856404; }
    .diagram { text-align: center; margin: 20px 0; }
    .follow-up { margin-top: 30px; padding: 15px; border: 1px dashed #dadce0; border-radius: 8px; }
    .tag { display: inline-block; background: #e8f0fe; color: #1a73e8; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin: 2px; }
    .series-nav { background: #f0f4ff; padding: 12px; border-radius: 8px; margin-bottom: 20px; }
    .series-nav a { color: #1a73e8; text-decoration: none; }
    table { border-collapse: collapse; width: 100%; margin: 15px 0; }
    th, td { border: 1px solid #dadce0; padding: 10px; text-align: left; }
    th { background: #f8f9fa; }
    .interview-q { background: #fce8e6; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ea4335; }
    .interview-q h4 { margin-top: 0; color: #c5221f; }
    @media (max-width: 700px) { .bilingual { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<div class="series-nav">
  ğŸ“š <strong>AI System Design é¢è¯•ç³»åˆ—</strong> â€” Day 2 of 5<br>
  <a href="2026-02-10-design-chatgpt-system.html">Day 1: è®¾è®¡ ChatGPT</a> â†’ <strong>Day 2: è®¾è®¡æ¨èç³»ç»Ÿ</strong> â†’ Day 3: è®¾è®¡è¯­ä¹‰æœç´¢
</div>

<h1>ğŸ¬ è®¾è®¡æ¨èç³»ç»Ÿ / Design a Recommendation System</h1>
<p>
  <span class="tag">System Design</span>
  <span class="tag">ML Interview</span>
  <span class="tag">Netflix</span>
  <span class="tag">YouTube</span>
  <span class="tag">Phase 2.1</span>
</p>
<p>ğŸ“… 2026-02-11 | å‚è€ƒ: YouTube DNN Paper (Covington 2016), Netflix Prize, Industry best practices</p>

<h2>ğŸ“– é¡¹ç›®ç®€ä»‹ / Overview</h2>
<div class="bilingual">
  <div class="zh">
    <p>"è®¾è®¡ä¸€ä¸ªæ¨èç³»ç»Ÿ"æ˜¯ ML System Design é¢è¯•ä¸­æœ€ç»å…¸çš„é¢˜ç›®ï¼Œå‡ ä¹æ‰€æœ‰å¤§å‚ï¼ˆNetflixã€YouTubeã€Amazonã€TikTokï¼‰éƒ½ä¼šè€ƒã€‚</p>
    <p>æ ¸å¿ƒæŒ‘æˆ˜ï¼šä»<strong>æ•°äº¿å€™é€‰å†…å®¹</strong>ä¸­ï¼Œåœ¨<strong>æ•°ç™¾æ¯«ç§’</strong>å†…ä¸ºæ¯ä¸ªç”¨æˆ·æŒ‘é€‰å‡ºæœ€ç›¸å…³çš„ 5-20 ä¸ªæ¨èã€‚</p>
    <p>ä»Šå¤©é‡ç‚¹è®²è§£ä¸šç•Œé€šç”¨çš„<strong>å¤šé˜¶æ®µæ¼æ–—æ¶æ„</strong>ï¼šCandidate Generation â†’ Lightweight Ranking â†’ Heavy Ranking â†’ Re-rankingï¼Œä»¥åŠæ¯ä¸€å±‚èƒŒåçš„è®¾è®¡æƒè¡¡ã€‚</p>
  </div>
  <div class="en">
    <p>"Design a recommendation system" is THE classic ML system design interview question. Asked at nearly every major tech company.</p>
    <p>Core challenge: select the best 5-20 items from <strong>hundreds of millions of candidates</strong> within <strong>hundreds of milliseconds</strong>.</p>
    <p>Today we cover the industry-standard <strong>multi-stage funnel architecture</strong>: Candidate Generation â†’ Lightweight Ranking â†’ Heavy Ranking â†’ Re-ranking, and the design trade-offs at each stage.</p>
  </div>
</div>

<h2>ğŸ—ï¸ æ•´ä½“æ¶æ„ / Overall Architecture</h2>

<div class="architecture">
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚         User Request            â”‚
                        â”‚   (user_id, context, session)   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚    Candidate Generation Layer    â”‚
                        â”‚    å¤šè·¯å¬å› (Multiple Sources)     â”‚
                        â”‚                                  â”‚
                        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                        â”‚  â”‚Two-  â”‚ â”‚Collabâ”‚ â”‚ Rule-    â”‚ â”‚
                        â”‚  â”‚Tower â”‚ â”‚Filterâ”‚ â”‚ Based    â”‚ â”‚
                        â”‚  â”‚Model â”‚ â”‚(CF)  â”‚ â”‚ (Hot/New)â”‚ â”‚
                        â”‚  â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
                        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
                        â”‚         ~10K candidates          â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚    Lightweight Ranking (L1)      â”‚
                        â”‚    ç²—æ’ï¼šå¿«é€Ÿè¿‡æ»¤ï¼Œä¼˜åŒ– Recall       â”‚
                        â”‚    Simple model + few features   â”‚
                        â”‚         ~500 candidates          â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚    Heavy Ranking (L2)            â”‚
                        â”‚    ç²¾æ’ï¼šå…¨ç‰¹å¾æ‰“åˆ†                 â”‚
                        â”‚    Deep model + rich features    â”‚
                        â”‚    Multi-task: CTR + Watch Time  â”‚
                        â”‚         ~50 candidates           â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚    Re-Ranking Layer              â”‚
                        â”‚    é‡æ’ï¼šä¸šåŠ¡é€»è¾‘ + å¤šæ ·æ€§           â”‚
                        â”‚    Diversity, freshness, policy  â”‚
                        â”‚         5-20 final results       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</div>

<div class="highlight">
  <h4>ğŸ”‘ æ ¸å¿ƒæ€æƒ³ï¼šé€å±‚è¿‡æ»¤çš„æ¼æ–— / Funnel of Progressive Filtering</h4>
  <p><strong>ä¸­æ–‡ï¼š</strong>1 äº¿å†…å®¹ä¸å¯èƒ½ç”¨ä¸€ä¸ªè¶…å¤æ‚æ¨¡å‹å…¨è·‘ä¸€éã€‚è§£æ³•æ˜¯åˆ†å±‚ï¼šè¶Šé å‰çš„å±‚è¶Šå¿«ä½†è¶Šç²—ç³™ï¼ˆå¬å›ç‡ä¼˜å…ˆï¼‰ï¼Œè¶Šé åçš„å±‚è¶Šæ…¢ä½†è¶Šç²¾å‡†ï¼ˆç²¾åº¦ä¼˜å…ˆï¼‰ã€‚</p>
  <p><strong>Englishï¼š</strong>You can't run a heavy model on 100M items. Solution: multi-stage funnel. Earlier stages prioritize recall (fast, rough), later stages prioritize precision (slow, accurate).</p>
</div>

<h2>âœ¨ é˜¶æ®µè¯¦è§£ / Stage Deep Dive</h2>

<h3>Stage 1: Candidate Generation (å¬å›å±‚)</h3>

<div class="bilingual">
  <div class="zh">
    <p><strong>ç›®æ ‡ï¼š</strong>ä»äº¿çº§ item pool ä¸­å¿«é€Ÿæ‰¾å‡º ~10K ä¸ªå€™é€‰</p>
    <p><strong>æ ¸å¿ƒæ–¹æ³• â€” Two-Tower Modelï¼ˆåŒå¡”æ¨¡å‹ï¼‰ï¼š</strong></p>
    <ul>
      <li><strong>User Towerï¼š</strong>ç¼–ç ç”¨æˆ·ç‰¹å¾ â†’ ç”¨æˆ· embedding</li>
      <li><strong>Item Towerï¼š</strong>ç¼–ç å†…å®¹ç‰¹å¾ â†’ å†…å®¹ embedding</li>
      <li>è®­ç»ƒç›®æ ‡ï¼šè®©æ­£æ ·æœ¬çš„ user-item cosine similarity é«˜</li>
      <li>æœåŠ¡æ—¶ï¼šç”¨ ANN (Approximate Nearest Neighbor) æ£€ç´¢æœ€è¿‘çš„ item</li>
    </ul>
    <p><strong>ä¸ºä»€ä¹ˆ Two-Tower å¥½ï¼š</strong></p>
    <ul>
      <li>Item embedding å¯ä»¥<strong>ç¦»çº¿é¢„è®¡ç®—</strong>ï¼Œå­˜åˆ°å‘é‡ç´¢å¼•</li>
      <li>åœ¨çº¿åªéœ€ç®— user embeddingï¼ˆä¸€æ¬¡å‰å‘ä¼ æ’­ï¼‰ï¼Œå†åš ANN æŸ¥è¯¢</li>
      <li>å»¶è¿Ÿæä½ï¼š< 10ms æ‰¾åˆ° Top-K</li>
    </ul>
    <p><strong>å¤šè·¯å¬å›ï¼š</strong>ä¸åªé ä¸€ä¸ªæ¨¡å‹ï¼Œå¹¶è¡Œè·‘å¤šä¸ª sourceï¼š</p>
    <ul>
      <li>Two-Tower ä¸ªæ€§åŒ–å¬å›</li>
      <li>ååŒè¿‡æ»¤ (çœ‹è¿‡Xçš„äººä¹Ÿçœ‹äº†Y)</li>
      <li>çƒ­é—¨/æ–°å†…å®¹ (ç¡®ä¿ cold-start coverage)</li>
      <li>å…³æ³¨çš„åˆ›ä½œè€…æœ€æ–°å†…å®¹</li>
    </ul>
  </div>
  <div class="en">
    <p><strong>Goal:</strong> Quickly select ~10K candidates from billions of items</p>
    <p><strong>Core Method â€” Two-Tower Model:</strong></p>
    <ul>
      <li><strong>User Tower:</strong> encodes user features â†’ user embedding</li>
      <li><strong>Item Tower:</strong> encodes item features â†’ item embedding</li>
      <li>Training: maximize cosine similarity for positive pairs</li>
      <li>Serving: ANN (Approximate Nearest Neighbor) retrieval</li>
    </ul>
    <p><strong>Why Two-Tower works:</strong></p>
    <ul>
      <li>Item embeddings can be <strong>pre-computed offline</strong> in a vector index</li>
      <li>Online: only compute user embedding (single forward pass) + ANN lookup</li>
      <li>Ultra-low latency: < 10ms for Top-K</li>
    </ul>
    <p><strong>Multiple retrieval sources (multi-channel recall):</strong></p>
    <ul>
      <li>Two-Tower personalized recall</li>
      <li>Collaborative Filtering (users who watched X also watched Y)</li>
      <li>Trending / New content (cold-start coverage)</li>
      <li>Subscribed creator's latest uploads</li>
    </ul>
  </div>
</div>

<pre><code>// Two-Tower æ¨¡å‹ä¼ªä»£ç 
class TwoTowerModel {
  userTower: DNN   // [user_id_emb, age, gender, watch_history_emb, ...] â†’ 128d
  itemTower: DNN   // [item_id_emb, title_emb, category, duration, ...] â†’ 128d

  // Training: contrastive loss / softmax cross-entropy
  loss(user, posItem, negItems) {
    userEmb  = this.userTower(user)        // [128]
    posEmb   = this.itemTower(posItem)     // [128]
    negEmbs  = negItems.map(i => this.itemTower(i))  // [N, 128]
    
    posSim   = cosineSim(userEmb, posEmb)
    negSims  = negEmbs.map(e => cosineSim(userEmb, e))
    return softmaxCrossEntropy(posSim, negSims)  // in-batch negatives
  }
  
  // Serving: pre-compute all item embeddings â†’ FAISS/ScaNN index
  // Online: compute userEmb â†’ ANN search â†’ Top-10K items in &lt;10ms
}</code></pre>

<h3>Stage 2: Lightweight Ranking â€” ç²—æ’ (L1)</h3>

<div class="bilingual">
  <div class="zh">
    <p><strong>ç›®æ ‡ï¼š</strong>ä» ~10K ç åˆ° ~500ï¼Œå¿«é€Ÿè¿‡æ»¤æ˜æ˜¾ä¸å¥½çš„å€™é€‰</p>
    <p><strong>æ¨¡å‹é€‰æ‹©ï¼š</strong>ç®€å•çš„æµ…å±‚ç½‘ç»œæˆ–é€»è¾‘å›å½’</p>
    <p><strong>å…³é”®ç‰¹å¾ï¼š</strong>æ˜“äºå¿«é€Ÿè®¡ç®—çš„ç‰¹å¾ï¼ˆä¸åšäº¤å‰ç‰¹å¾ï¼‰</p>
    <ul>
      <li>ç”¨æˆ·-item embedding ç‚¹ç§¯ (æ¥è‡ªå¬å›æ¨¡å‹)</li>
      <li>Item çƒ­åº¦ç»Ÿè®¡ (CTR, æ’­æ”¾é‡)</li>
      <li>ç®€å•çš„ç”¨æˆ·åå¥½åŒ¹é… (ç±»ç›®, æ—¶é•¿)</li>
    </ul>
    <p><strong>ä¼˜åŒ–ç›®æ ‡ï¼š</strong>Recall@500 â€”â€” ç¡®ä¿å¥½çš„å€™é€‰ä¸è¢«è¯¯åˆ </p>
  </div>
  <div class="en">
    <p><strong>Goal:</strong> Trim ~10K â†’ ~500, quickly filter out poor candidates</p>
    <p><strong>Model:</strong> Shallow NN or logistic regression</p>
    <p><strong>Features:</strong> Fast-to-compute, no expensive cross-features</p>
    <ul>
      <li>User-item embedding dot product from retrieval</li>
      <li>Item popularity stats (CTR, view count)</li>
      <li>Simple preference matching (category, duration)</li>
    </ul>
    <p><strong>Optimization target:</strong> Recall@500 â€” don't drop good candidates</p>
  </div>
</div>

<h3>Stage 3: Heavy Ranking â€” ç²¾æ’ (L2)</h3>

<div class="bilingual">
  <div class="zh">
    <p><strong>è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿæœ€æ ¸å¿ƒçš„æ¨¡å‹</strong>ï¼Œä¹Ÿæ˜¯é¢è¯•æœ€çˆ±è€ƒçš„éƒ¨åˆ†ã€‚</p>
    <p><strong>æ¨¡å‹ï¼š</strong>Deep & Cross Network / Multi-task æ¨¡å‹</p>
    <p><strong>Multi-Task Learning (å¤šä»»åŠ¡å­¦ä¹ )ï¼š</strong></p>
    <ul>
      <li>Task 1: P(click) â€” é¢„æµ‹ç”¨æˆ·æ˜¯å¦ä¼šç‚¹å‡»</li>
      <li>Task 2: E[watch_time] â€” é¢„æµ‹è§‚çœ‹æ—¶é•¿</li>
      <li>Task 3: P(like) â€” é¢„æµ‹ç”¨æˆ·æ˜¯å¦ä¼šç‚¹èµ</li>
      <li>Task 4: P(share) â€” é¢„æµ‹ç”¨æˆ·æ˜¯å¦ä¼šåˆ†äº«</li>
    </ul>
    <p><strong>æœ€ç»ˆå¾—åˆ† = Value Model åŠ æƒç»„åˆï¼š</strong></p>
    <p><code>score = w1 * P(click) * E[watch_time] + w2 * P(like) + w3 * P(share) - w4 * P(dislike)</code></p>
    <p>æƒé‡ w1-w4 ç”±ä¸šåŠ¡ç›®æ ‡å†³å®šï¼Œå¯ä»¥<strong>åœ¨çº¿è°ƒèŠ‚</strong>è€Œä¸é‡æ–°è®­ç»ƒæ¨¡å‹ã€‚</p>
  </div>
  <div class="en">
    <p><strong>This is the core model of the entire system</strong> and the most popular interview focus.</p>
    <p><strong>Model:</strong> Deep & Cross Network / Multi-task model</p>
    <p><strong>Multi-Task Learning:</strong></p>
    <ul>
      <li>Task 1: P(click) â€” predict click probability</li>
      <li>Task 2: E[watch_time] â€” predict watch time</li>
      <li>Task 3: P(like) â€” predict like probability</li>
      <li>Task 4: P(share) â€” predict share probability</li>
    </ul>
    <p><strong>Final Score = Value Model weighted combination:</strong></p>
    <p><code>score = w1 * P(click) * E[watch_time] + w2 * P(like) + w3 * P(share) - w4 * P(dislike)</code></p>
    <p>Weights w1-w4 are determined by business objectives and can be <strong>tuned online</strong> without retraining.</p>
  </div>
</div>

<div class="highlight">
  <h4>ğŸ’¡ è®¾è®¡äº®ç‚¹ï¼šMulti-Task çš„ Shared-Bottom vs MMoE</h4>
  <p><strong>Shared-Bottomï¼š</strong>æ‰€æœ‰ task å…±äº«åº•å±‚å‚æ•°ï¼Œç®€å•ä½† task å†²çªæ—¶è¡¨ç°å·®ï¼ˆå¦‚ click å’Œ watch_time å¯èƒ½è´Ÿç›¸å…³â€”â€”clickbait é«˜ç‚¹å‡»ä½è§‚çœ‹ï¼‰ã€‚</p>
  <p><strong>MMoE (Multi-gate Mixture-of-Experts)ï¼š</strong>å¤šä¸ª expert ç½‘ç»œ + æ¯ä¸ª task æœ‰è‡ªå·±çš„ gating ç½‘ç»œé€‰æ‹©æ€§ç»„åˆ expert è¾“å‡ºã€‚è§£å†³ task å†²çªï¼ŒGoogle åœ¨ YouTube å®é™…ä½¿ç”¨ã€‚</p>
</div>

<pre><code>// Multi-Task Heavy Ranker ä¼ªä»£ç 
class HeavyRanker {
  // ç‰¹å¾å·¥ç¨‹ â€” è¿™é‡Œä½“ç°ç³»ç»Ÿè®¾è®¡åŠŸåº•
  features = {
    // User features
    user_embedding: float[128],
    user_age_bucket: categorical,
    user_country: categorical,
    recent_watch_categories: multi-hot[50],
    avg_session_duration: float,
    
    // Item features
    item_embedding: float[128],
    item_duration: float,
    item_freshness: float,     // hours since upload
    item_quality_score: float, // pre-computed from likes/views ratio
    creator_subscriber_count: float,
    
    // Cross features (User Ã— Item interaction)
    user_creator_affinity: float,    // how often user watches this creator
    category_match_score: float,     // user pref vs item category
    user_item_covisit: float,        // co-watch signal
  }
  
  // MMoE Architecture
  experts: DNN[8]          // 8 expert networks
  gates: {                 // per-task gating
    click: GatingNetwork,
    watch_time: GatingNetwork,
    like: GatingNetwork,
  }
  task_heads: {            // per-task output
    click: Linear â†’ sigmoid,      // P(click)
    watch_time: Linear â†’ ReLU,    // E[watch_time] in seconds
    like: Linear â†’ sigmoid,       // P(like)
  }
}</code></pre>

<h3>Stage 4: Re-Ranking â€” é‡æ’ (ä¸šåŠ¡é€»è¾‘å±‚)</h3>

<div class="bilingual">
  <div class="zh">
    <p><strong>ç›®æ ‡ï¼š</strong>ä¸åªçœ‹å•ä¸ª item å¥½ä¸å¥½ï¼Œè¿˜è¦çœ‹æ•´ä¸ªæ¨èåˆ—è¡¨å¥½ä¸å¥½</p>
    <p><strong>å…³é”®ç­–ç•¥ï¼š</strong></p>
    <ul>
      <li><strong>å¤šæ ·æ€§ (Diversity)ï¼š</strong>MMR ç®—æ³•å»é‡ï¼Œé¿å…æ¨ 5 ä¸ªåŒç±»è§†é¢‘</li>
      <li><strong>æ–°é²œåº¦ (Freshness)ï¼š</strong>æ–°å†…å®¹ boostï¼Œä¿è¯æ–°åˆ›ä½œè€…æœ‰æ›å…‰</li>
      <li><strong>ä¸šåŠ¡è§„åˆ™ï¼š</strong>è¿‡æ»¤å·²çœ‹ã€ç‰ˆæƒé—®é¢˜ã€å¹´é¾„é™åˆ¶</li>
      <li><strong>Exploration vs Exploitationï¼š</strong>Îµ-greedy æˆ– Thompson Sampling æ¢ç´¢æ–°å…´è¶£</li>
    </ul>
  </div>
  <div class="en">
    <p><strong>Goal:</strong> Optimize the entire slate, not just individual items</p>
    <p><strong>Key strategies:</strong></p>
    <ul>
      <li><strong>Diversity:</strong> MMR algorithm to de-duplicate categories</li>
      <li><strong>Freshness:</strong> Boost new content, ensure creator exposure</li>
      <li><strong>Business rules:</strong> Filter watched, copyright, age-gated</li>
      <li><strong>Exploration:</strong> Îµ-greedy or Thompson Sampling for interest discovery</li>
    </ul>
  </div>
</div>

<h2>âš¡ å…³é”®è®¾è®¡æƒè¡¡ / Key Design Trade-offs</h2>

<table>
  <tr><th>æƒè¡¡ / Trade-off</th><th>æ–¹æ¡ˆ A</th><th>æ–¹æ¡ˆ B</th><th>æ¨èåšæ³•</th></tr>
  <tr>
    <td>Batch vs Real-time</td>
    <td>Batch é¢„è®¡ç®—æ¨èï¼ˆä½æˆæœ¬ï¼‰</td>
    <td>Real-time åœ¨çº¿è®¡ç®—ï¼ˆé«˜æ—¶æ•ˆï¼‰</td>
    <td>æ··åˆï¼šå¬å›å±‚ç”¨ batch é¢„è®¡ç®— embedding + æ’åºå±‚ real-time</td>
  </tr>
  <tr>
    <td>å•ç›®æ ‡ vs å¤šç›®æ ‡</td>
    <td>åªä¼˜åŒ– CTRï¼ˆç®€å•ï¼‰</td>
    <td>Multi-task å¤šç›®æ ‡ï¼ˆå¤æ‚ï¼‰</td>
    <td>Multi-task + Value Model åŠ æƒï¼Œé¿å… clickbait</td>
  </tr>
  <tr>
    <td>Explore vs Exploit</td>
    <td>å…¨ç”¨æ¨¡å‹é¢„æµ‹ï¼ˆexploitï¼‰</td>
    <td>éšæœºæ¢ç´¢ï¼ˆexploreï¼‰</td>
    <td>90% exploit + 10% explore (Thompson Sampling)</td>
  </tr>
  <tr>
    <td>å®æ—¶ç‰¹å¾ vs å»¶è¿Ÿ</td>
    <td>ç”¨æ›´å¤šå®æ—¶ç‰¹å¾ï¼ˆå‡†ï¼‰</td>
    <td>å°‘ç”¨ç‰¹å¾ï¼ˆå¿«ï¼‰</td>
    <td>Feature Store åˆ†å±‚ï¼šL1 ç”¨ç¼“å­˜ç‰¹å¾ï¼ŒL2 ç”¨å®æ—¶ç‰¹å¾</td>
  </tr>
</table>

<h2>ğŸ“Š å®¹é‡ä¼°ç®— / Capacity Estimation</h2>

<div class="bilingual">
  <div class="zh">
    <ul>
      <li><strong>DAUï¼š</strong>10 äº¿ç”¨æˆ·</li>
      <li><strong>å†…å®¹åº“ï¼š</strong>10 äº¿è§†é¢‘ (YouTube é‡çº§)</li>
      <li><strong>æ¯ç”¨æˆ·æ¯å¤©è¯·æ±‚ï¼š</strong>~50 æ¬¡æ¨èè¯·æ±‚</li>
      <li><strong>QPSï¼š</strong>10â¹ Ã— 50 / 86400 â‰ˆ <strong>~580K QPS</strong></li>
      <li><strong>å»¶è¿Ÿé¢„ç®—ï¼š</strong></li>
      <ul>
        <li>å¬å› (ANN): < 10ms</li>
        <li>ç²—æ’ (L1): < 20ms</li>
        <li>ç²¾æ’ (L2): < 50ms (500 items Ã— DNN inference)</li>
        <li>é‡æ’: < 5ms</li>
        <li>æ€»è®¡: < 100ms (P99 < 200ms)</li>
      </ul>
      <li><strong>Embedding å­˜å‚¨ï¼š</strong>10â¹ items Ã— 128 dims Ã— 4 bytes = <strong>~512 GB</strong> (FAISS å¯æ”¾å†…å­˜)</li>
    </ul>
  </div>
  <div class="en">
    <ul>
      <li><strong>DAU:</strong> 1B users</li>
      <li><strong>Content catalog:</strong> 1B videos</li>
      <li><strong>Requests per user/day:</strong> ~50 recommendation requests</li>
      <li><strong>QPS:</strong> 10â¹ Ã— 50 / 86400 â‰ˆ <strong>~580K QPS</strong></li>
      <li><strong>Latency budget:</strong></li>
      <ul>
        <li>Retrieval (ANN): < 10ms</li>
        <li>L1 Ranking: < 20ms</li>
        <li>L2 Ranking: < 50ms</li>
        <li>Re-ranking: < 5ms</li>
        <li>End-to-end: < 100ms (P99 < 200ms)</li>
      </ul>
      <li><strong>Embedding storage:</strong> 10â¹ Ã— 128 Ã— 4B = <strong>~512 GB</strong> (fits in FAISS cluster)</li>
    </ul>
  </div>
</div>

<h2>ğŸ”§ Feature Store æ¶æ„ / Feature Engineering</h2>

<div class="architecture">
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                 Feature Store                     â”‚
  â”‚                                                   â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚  â”‚  Batch       â”‚  â”‚  Near-RT     â”‚  â”‚ Real-timeâ”‚ â”‚
  â”‚  â”‚  Features    â”‚  â”‚  Features    â”‚  â”‚ Features â”‚ â”‚
  â”‚  â”‚  (daily)     â”‚  â”‚  (minutes)   â”‚  â”‚ (live)   â”‚ â”‚
  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
  â”‚  â”‚user_pref    â”‚  â”‚trending_scoreâ”‚  â”‚session   â”‚ â”‚
  â”‚  â”‚item_quality â”‚  â”‚recent_ctr    â”‚  â”‚  context â”‚ â”‚
  â”‚  â”‚creator_statsâ”‚  â”‚fresh_uploads â”‚  â”‚last_watchâ”‚ â”‚
  â”‚  â”‚embeddings   â”‚  â”‚social_signalsâ”‚  â”‚position  â”‚ â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
  â”‚         â”‚  Hive/Spark     â”‚ Flink/Kafka   â”‚ Redis â”‚
  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</div>

<div class="highlight">
  <h4>ğŸ’¡ è®¾è®¡äº®ç‚¹ï¼šTraining-Serving Skew é—®é¢˜</h4>
  <p><strong>é—®é¢˜ï¼š</strong>è®­ç»ƒæ—¶ç”¨çš„ç‰¹å¾å’Œçº¿ä¸Šæ¨ç†æ—¶çš„ç‰¹å¾ä¸ä¸€è‡´ï¼ˆæ¯”å¦‚è®­ç»ƒç”¨çš„æ˜¯ label æ—¶é—´ç‚¹çš„ç‰¹å¾ï¼Œä½†çº¿ä¸Šç”¨çš„æ˜¯å½“å‰ç‰¹å¾ï¼‰ï¼Œä¼šå¯¼è‡´æ¨¡å‹æ•ˆæœä¸‹é™ã€‚</p>
  <p><strong>è§£æ³•ï¼š</strong>Feature Store ç»Ÿä¸€ç®¡ç†ï¼Œtraining pipeline å’Œ serving pipeline è¯»åŒä¸€ä¸ª Feature Storeï¼Œç¡®ä¿ point-in-time correctnessã€‚</p>
</div>

<h2>ğŸ§Š Cold Start é—®é¢˜ / Cold Start</h2>

<div class="bilingual">
  <div class="zh">
    <h4>æ–°ç”¨æˆ· Cold Start</h4>
    <ul>
      <li>å…ˆæ¨çƒ­é—¨å†…å®¹ + åŸºäºæ³¨å†Œä¿¡æ¯ (å¹´é¾„/åœ°åŒº) çš„æ³›åŒ–æ¨è</li>
      <li>Onboarding è®©ç”¨æˆ·é€‰å…´è¶£æ ‡ç­¾</li>
      <li>å¿«é€Ÿä» explore æ¨¡å¼è¿‡æ¸¡åˆ° exploit æ¨¡å¼ (é€šå¸¸ 5-10 æ¬¡äº¤äº’å)</li>
    </ul>
    <h4>æ–°å†…å®¹ Cold Start</h4>
    <ul>
      <li>åŸºäºå†…å®¹ç‰¹å¾ (æ ‡é¢˜/æ ‡ç­¾/è§†è§‰ç‰¹å¾) åŒ¹é…ç›¸ä¼¼å·²æœ‰å†…å®¹çš„ embedding</li>
      <li>ç»™æ–°å†…å®¹ä¸€ä¸ª exploration budgetï¼ˆä¿è¯ä¸€å®šæ›å…‰é‡ï¼‰</li>
      <li>åˆ©ç”¨åˆ›ä½œè€…å†å²è¡¨ç°ä½œä¸º prior</li>
    </ul>
  </div>
  <div class="en">
    <h4>New User Cold Start</h4>
    <ul>
      <li>Start with trending + demographic-based recommendations</li>
      <li>Onboarding flow: let users pick interest tags</li>
      <li>Quickly transition from explore to exploit (after ~5-10 interactions)</li>
    </ul>
    <h4>New Item Cold Start</h4>
    <ul>
      <li>Content-based features (title/tags/visual) to bootstrap embedding</li>
      <li>Exploration budget: guarantee minimum impressions</li>
      <li>Use creator's historical performance as prior</li>
    </ul>
  </div>
</div>

<h2>ğŸ¤ é¢è¯•é«˜é¢‘é—®é¢˜ / Interview Questions</h2>

<div class="interview-q">
  <h4>Q1: ä¸ºä»€ä¹ˆéœ€è¦å¤šé˜¶æ®µæ¶æ„ï¼Ÿç›´æ¥ç”¨ä¸€ä¸ªæ¨¡å‹ä¸è¡Œå—ï¼Ÿ</h4>
  <p><strong>ç­”ï¼š</strong>è®¡ç®—æˆæœ¬ã€‚å‡è®¾ç²¾æ’æ¨¡å‹æ¨ç†ä¸€ä¸ª item éœ€è¦ 0.1msï¼Œ10 äº¿ item å°±éœ€è¦ ~28 å°æ—¶ã€‚åˆ†å±‚åï¼šå¬å›ï¼ˆANN, 10msï¼‰â†’ ç²—æ’ï¼ˆ10K Ã— ç®€å•æ¨¡å‹ï¼‰â†’ ç²¾æ’ï¼ˆ500 Ã— å¤æ‚æ¨¡å‹, 50msï¼‰ã€‚æ€»å»¶è¿Ÿä»ä¸å¯èƒ½é™åˆ° < 100msã€‚æœ¬è´¨æ˜¯<strong>ç”¨ recall æ¢ precision</strong>çš„åˆ†å±‚ç­–ç•¥ã€‚</p>
</div>

<div class="interview-q">
  <h4>Q2: å¦‚ä½•å¤„ç† position biasï¼Ÿæ’åœ¨å‰é¢çš„å†…å®¹å¤©ç„¶è·å¾—æ›´å¤šç‚¹å‡»ã€‚</h4>
  <p><strong>ç­”ï¼š</strong>ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
  <ol>
    <li><strong>è®­ç»ƒæ—¶</strong>ï¼šå°† position ä½œä¸º feature è¾“å…¥æ¨¡å‹ï¼Œä½† serving æ—¶ position è®¾ä¸º 0 æˆ–å¹³å‡å€¼</li>
    <li><strong>Inverse Propensity Weighting (IPW)</strong>ï¼šç»™ä¸åŒ position çš„æ ·æœ¬ä¸åŒæƒé‡</li>
    <li><strong>Causal inference</strong>ï¼šå¶å°”éšæœºæ‰“ä¹±æ’åºæ”¶é›†æ— åæ•°æ®</li>
  </ol>
</div>

<div class="interview-q">
  <h4>Q3: å¦‚ä½•é¿å…æ¨èç³»ç»Ÿå½¢æˆ "ä¿¡æ¯èŒ§æˆ¿" (filter bubble)ï¼Ÿ</h4>
  <p><strong>ç­”ï¼š</strong></p>
  <ol>
    <li><strong>Re-ranking å±‚åŠ å¤šæ ·æ€§çº¦æŸ</strong>ï¼šMMR (Maximal Marginal Relevance) æƒ©ç½šç›¸ä¼¼å€™é€‰</li>
    <li><strong>Exploration ç­–ç•¥</strong>ï¼šThompson Sampling / Îµ-greedy å¼•å…¥éšæœºæ€§</li>
    <li><strong>ä¸šåŠ¡æŒ‡æ ‡åŠ å…¥å¤šæ ·æ€§</strong>ï¼šé™¤äº† CTRï¼Œè¿˜è¿½è¸ª category coverage / unique creators viewed</li>
    <li><strong>Value Model è°ƒæƒ</strong>ï¼šé™ä½çº¯ engagement æƒé‡ï¼Œæå‡ satisfaction æƒé‡</li>
  </ol>
</div>

<div class="interview-q">
  <h4>Q4: Two-Tower æ¨¡å‹çš„å±€é™æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•æ”¹è¿›ï¼Ÿ</h4>
  <p><strong>ç­”ï¼š</strong>Two-Tower çš„å±€é™æ˜¯<strong>user å’Œ item æ²¡æœ‰äº¤å‰ (interaction)</strong> â€” å„è‡ªç‹¬ç«‹ç¼–ç å†åšç‚¹ç§¯ï¼Œè¡¨è¾¾èƒ½åŠ›æœ‰é™ã€‚æ”¹è¿›æ–¹æ¡ˆï¼š</p>
  <ol>
    <li><strong>äº¤å‰ç‰¹å¾åŠ åˆ°ç²¾æ’</strong>ï¼šTwo-Tower åªç”¨äºå¬å›ï¼Œç²¾æ’æ¨¡å‹ç”¨ Deep & Cross æ•æ‰äº¤å‰</li>
    <li><strong>Late interaction</strong>ï¼šå¦‚ ColBERT çš„ token-level interactionï¼Œä½†è®¡ç®—ä»£ä»·æ›´é«˜</li>
    <li><strong>æ··åˆæ¶æ„</strong>ï¼šTwo-Tower åšå¿«é€Ÿå¬å› + attention-based model åšç²¾æ’</li>
  </ol>
</div>

<h2>ğŸ“š å¯å­¦ä¹ çš„æ¨¡å¼ / Patterns to Learn</h2>

<div class="bilingual">
  <div class="zh">
    <ol>
      <li><strong>å¤šé˜¶æ®µæ¼æ–—æ¨¡å¼</strong>ï¼šé€‚ç”¨äºæ‰€æœ‰å¤§è§„æ¨¡æ£€ç´¢+æ’åºåœºæ™¯ï¼ˆæœç´¢ã€å¹¿å‘Šã€æ¨èï¼‰ã€‚é¢è¯•ä¸‡é‡‘æ²¹ã€‚</li>
      <li><strong>Embedding + ANN æ£€ç´¢</strong>ï¼šå°†å¤æ‚åŒ¹é…é—®é¢˜è½¬åŒ–ä¸ºå‘é‡ç©ºé—´è¿‘é‚»æœç´¢ï¼Œæå¤§é™ä½åœ¨çº¿å»¶è¿Ÿã€‚</li>
      <li><strong>Multi-Task Learning</strong>ï¼šç”¨ä¸€ä¸ªæ¨¡å‹é¢„æµ‹å¤šä¸ªç›®æ ‡ï¼Œå†ç”¨ Value Model ç»„åˆã€‚è§£è€¦äº† ML è®­ç»ƒå’Œä¸šåŠ¡ç›®æ ‡è°ƒä¼˜ã€‚</li>
      <li><strong>Feature Store åˆ†å±‚</strong>ï¼šbatch / near-real-time / real-time ä¸‰å±‚ç‰¹å¾ä½“ç³»ï¼Œå¹³è¡¡æ–°é²œåº¦å’Œæˆæœ¬ã€‚</li>
      <li><strong>Explore vs Exploit</strong>ï¼šä»»ä½•æ¨è/å†³ç­–ç³»ç»Ÿéƒ½éœ€è¦å¹³è¡¡åˆ©ç”¨å·²çŸ¥åå¥½å’Œå‘ç°æ–°å…´è¶£ã€‚</li>
    </ol>
  </div>
  <div class="en">
    <ol>
      <li><strong>Multi-stage funnel</strong>: Universal pattern for search, ads, recommendations. Interview gold.</li>
      <li><strong>Embedding + ANN retrieval</strong>: Turn complex matching into vector nearest-neighbor search.</li>
      <li><strong>Multi-Task Learning</strong>: One model, multiple objectives, combined via Value Model. Decouples ML training from business tuning.</li>
      <li><strong>Feature Store tiers</strong>: batch / near-RT / real-time â€” balance freshness vs cost.</li>
      <li><strong>Explore vs Exploit</strong>: Every recommendation system needs this balance.</li>
    </ol>
  </div>
</div>

<h2>ğŸ”— ä¸æ˜¨å¤©çš„è”ç³» / Connection to Day 1</h2>

<div class="highlight">
  <h4>ChatGPT vs æ¨èç³»ç»Ÿçš„å…±é€šè®¾è®¡æ¨¡å¼</h4>
  <ul>
    <li>ä¸¤è€…éƒ½æœ‰<strong>å¤šå±‚å¤„ç†æ¶æ„</strong>ï¼šChatGPT çš„ Gateway â†’ Router â†’ LLM â†’ Safety | æ¨èçš„ Retrieval â†’ L1 â†’ L2 â†’ Re-rank</li>
    <li>ä¸¤è€…éƒ½å…³æ³¨<strong>å»¶è¿Ÿä¼˜åŒ–</strong>ï¼šChatGPT ç”¨ SSE æµå¼ | æ¨èç”¨æ¼æ–—é€å±‚å‡å°‘è®¡ç®—é‡</li>
    <li>ä¸¤è€…éƒ½éœ€è¦<strong>Safety / Policy å±‚</strong>ï¼šChatGPT çš„ content filter | æ¨èçš„ re-ranking business rules</li>
    <li>ä¸¤è€…éƒ½æ¶‰åŠ<strong>æˆæœ¬ vs è´¨é‡æƒè¡¡</strong>ï¼šChatGPT çš„ model routing | æ¨èçš„ L1 vs L2 æ¨¡å‹å¤æ‚åº¦å·®å¼‚</li>
  </ul>
</div>

<div class="follow-up">
  <h3>ğŸ’¬ åç»­è®¨è®º / Follow-up Discussion</h3>
  <p>æƒ³æ·±å…¥äº†è§£å“ªéƒ¨åˆ†ï¼Ÿæ¯”å¦‚ Two-Tower è®­ç»ƒç»†èŠ‚ã€Feature Store å…·ä½“å®ç°ã€æˆ–è€…é¢è¯• mock practiceï¼Ÿ</p>
  <p>ğŸ“… æ˜å¤© Day 3: <strong>è®¾è®¡è¯­ä¹‰æœç´¢å¼•æ“</strong> â€” ä»æ¨èåˆ°æœç´¢ï¼Œçœ‹ Embedding Retrieval åœ¨ä¸åŒåœºæ™¯çš„åº”ç”¨å·®å¼‚ï¼</p>
</div>

</body>
</html>
