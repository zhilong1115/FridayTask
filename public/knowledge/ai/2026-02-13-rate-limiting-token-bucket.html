<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rate Limiting æ·±åº¦è§£æï¼šToken Bucket ç®—æ³• | Knowledge Push</title>
<style>
  :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #e6edf3; --muted: #8b949e; --accent: #58a6ff; --green: #3fb950; --orange: #d29922; --red: #f85149; --purple: #bc8cff; }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; line-height: 1.7; padding: 2rem; max-width: 900px; margin: 0 auto; }
  h1 { font-size: 2rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, var(--accent), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  h2 { color: var(--accent); margin: 2rem 0 1rem; font-size: 1.4rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
  h3 { color: var(--green); margin: 1.5rem 0 0.8rem; font-size: 1.15rem; }
  .meta { color: var(--muted); margin-bottom: 2rem; font-size: 0.9rem; }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin: 1.2rem 0; }
  .card.highlight { border-left: 4px solid var(--accent); }
  .card.warn { border-left: 4px solid var(--orange); }
  .card.success { border-left: 4px solid var(--green); }
  pre { background: #1a1f2b; border-radius: 8px; padding: 1.2rem; overflow-x: auto; font-size: 0.88rem; line-height: 1.5; margin: 1rem 0; }
  code { font-family: 'SF Mono', 'Fira Code', monospace; color: #c9d1d9; }
  .inline-code { background: #1a1f2b; padding: 0.15em 0.4em; border-radius: 4px; font-size: 0.9em; }
  table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.92rem; }
  th, td { padding: 0.7rem 1rem; border: 1px solid var(--border); text-align: left; }
  th { background: var(--card); color: var(--accent); }
  td { background: var(--bg); }
  .emoji { font-size: 1.2em; }
  .tag { display: inline-block; padding: 0.15em 0.6em; border-radius: 12px; font-size: 0.8rem; font-weight: 600; margin-right: 0.4em; }
  .tag-blue { background: rgba(88,166,255,0.15); color: var(--accent); }
  .tag-green { background: rgba(63,185,80,0.15); color: var(--green); }
  .tag-purple { background: rgba(188,140,255,0.15); color: var(--purple); }
  .thought-box { background: linear-gradient(135deg, rgba(88,166,255,0.08), rgba(188,140,255,0.08)); border: 1px solid var(--purple); border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; }
  .thought-box h4 { color: var(--purple); margin-bottom: 0.5rem; }
  ul, ol { padding-left: 1.5rem; margin: 0.5rem 0; }
  li { margin: 0.3rem 0; }
  .diagram { font-family: 'SF Mono', monospace; font-size: 0.85rem; line-height: 1.4; white-space: pre; color: var(--green); }
  a { color: var(--accent); }
</style>
</head>
<body>

<h1>ğŸª£ Rate Limiting æ·±åº¦è§£æï¼šToken Bucket ç®—æ³•</h1>
<p class="meta">
  <span class="tag tag-blue">System Design</span>
  <span class="tag tag-green">Rate Limiting</span>
  <span class="tag tag-purple">Interview Ready</span>
  2026-02-13 Â· Knowledge Push Â· AI/Tech Series
</p>

<div class="card highlight">
<strong>ğŸ’¡ ä¸ºä»€ä¹ˆå­¦è¿™ä¸ª / Why This Matters</strong><br>
ä½ åœ¨ç”¨ Claude Max çš„æ—¶å€™å‘ç°äº† 5 å°æ—¶æ»šåŠ¨çª—å£é™é¢â€”â€”è¿™èƒŒåå°±æ˜¯ Token Bucket ç®—æ³•ã€‚å®ƒæ˜¯äº’è”ç½‘ä¸–ç•Œé‡Œæœ€åŸºç¡€çš„"æµé‡å®ˆé—¨å‘˜"ï¼Œä» Nginx åˆ° AWS API Gatewayï¼Œä» Stripe åˆ° OpenAIï¼Œå‡ ä¹æ‰€æœ‰ API rate limiting éƒ½ä¾èµ–å®ƒã€‚é¢è¯•ä¸­ "Design a Rate Limiter" ä¹Ÿæ˜¯ç»å…¸ç³»ç»Ÿè®¾è®¡é¢˜ã€‚
</div>

<!-- ==================== SECTION 1 ==================== -->
<h2>ä¸€ã€Token Bucketï¼šä¸€ä¸ªæ°´é¾™å¤´çš„æ•…äº‹ ğŸš°</h2>

<h3>ç›´è§‰åŒ–ç†è§£</h3>
<p>æƒ³è±¡ä½ æœ‰ä¸€ä¸ª<strong>è£…ä»£å¸çš„æ¡¶</strong>ï¼ˆToken Bucketï¼‰ï¼š</p>

<div class="card success">
<div class="diagram">
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Token Generator â”‚  â† åŒ€é€Ÿå¾€æ¡¶é‡Œæ”¾ä»£å¸ï¼ˆrateï¼‰
    â”‚   â±ï¸ æ¯ç§’ r ä¸ª    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ ğŸ’°ğŸ’°ğŸ’°
             â–¼
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘   ğŸª£ Token Bucket â•‘  â† æ¡¶æœ€å¤šè£… b ä¸ªä»£å¸ï¼ˆburst capacityï¼‰
    â•‘   ğŸ’°ğŸ’°ğŸ’°ğŸ’°ğŸ’°ğŸ’°ğŸ’°  â•‘
    â•šâ•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ğŸ“¨ æ¯ä¸ªè¯·æ±‚æ¶ˆè€—   â”‚  â† æœ‰ä»£å¸ â†’ æ”¾è¡Œ âœ…
    â”‚     1 ä¸ªä»£å¸       â”‚     æ²¡ä»£å¸ â†’ æ‹’ç» âŒ (429)
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</div>
</div>

<p><strong>å››ä¸ªæ ¸å¿ƒå‚æ•°ï¼š</strong></p>
<ol>
  <li><strong>Rate (r)</strong>ï¼šä»£å¸è¡¥å……é€Ÿåº¦ï¼Œå¦‚ 10 tokens/sec</li>
  <li><strong>Burst (b)</strong>ï¼šæ¡¶çš„æœ€å¤§å®¹é‡ï¼Œå¦‚ 100 tokens</li>
  <li><strong>Tokens</strong>ï¼šå½“å‰æ¡¶é‡Œçš„ä»£å¸æ•°</li>
  <li><strong>Last refill time</strong>ï¼šä¸Šæ¬¡è¡¥å……ä»£å¸çš„æ—¶é—´æˆ³</li>
</ol>

<h3>å…³é”®ç‰¹æ€§</h3>
<div class="card">
<p><strong>ğŸ”‘ å…è®¸çªå‘æµé‡ï¼ˆBurstï¼‰</strong>ï¼šè¿™æ˜¯ Token Bucket æœ€å¤§çš„ä¼˜åŠ¿ã€‚å¦‚æœæ¡¶æ»¡äº†æœ‰ 100 ä¸ªä»£å¸ï¼Œä½ å¯ä»¥ç¬é—´å‘ 100 ä¸ªè¯·æ±‚â€”â€”ç„¶åå›åˆ°æ¯ç§’ 10 ä¸ªçš„ç¨³æ€é€Ÿç‡ã€‚</p>
<p style="margin-top: 0.8rem;"><strong>Claude Max çš„ä¾‹å­</strong>ï¼š5 å°æ—¶æ»šåŠ¨çª—å£ï¼Œä¸Šé™ N æ¡æ¶ˆæ¯ã€‚ä½ å¯ä»¥ä¸€å£æ°”æŠŠé¢åº¦ç”¨å®Œï¼ˆburstï¼‰ï¼Œç„¶åç­‰ä»£å¸æ…¢æ…¢å›å¤â€”â€”è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ ä¼šçœ‹åˆ° "limit resets in X hours" çš„å€’è®¡æ—¶ã€‚</p>
</div>

<h3>æ•°å­¦æ¨¡å‹</h3>
<div class="card">
<p>åœ¨æ—¶åˆ» t è¯·æ±‚åˆ°è¾¾æ—¶ï¼š</p>
<pre><code>// 1. è®¡ç®—åº”è¯¥è¡¥å……çš„ä»£å¸
elapsed = now - last_refill_time
tokens = min(b, tokens + elapsed * r)
last_refill_time = now

// 2. åˆ¤æ–­æ˜¯å¦æ”¾è¡Œ
if tokens >= cost:
    tokens -= cost
    ALLOW âœ…
else:
    DENY âŒ (HTTP 429 Too Many Requests)</code></pre>
<p style="margin-top: 0.5rem; color: var(--muted);">æ³¨æ„ï¼šä»£å¸æ˜¯"æ‡’è¡¥å……"ï¼ˆlazy refillï¼‰â€”â€”ä¸éœ€è¦çœŸçš„æ¯ç§’å¾€æ¡¶é‡Œå¡ï¼Œåªåœ¨è¯·æ±‚æ¥çš„æ—¶å€™è®¡ç®—ä¸€ä¸‹è¯¥è¡¥å¤šå°‘å°±è¡Œã€‚è¿™è®©å®ç°æå…¶è½»é‡ã€‚</p>
</div>

<!-- ==================== SECTION 2 ==================== -->
<h2>äºŒã€å››å¤§ Rate Limiting ç®—æ³•å¯¹æ¯” âš”ï¸</h2>

<table>
<tr>
  <th>ç®—æ³•</th>
  <th>åŸç†</th>
  <th>ä¼˜ç‚¹</th>
  <th>ç¼ºç‚¹</th>
  <th>é€‚ç”¨åœºæ™¯</th>
</tr>
<tr>
  <td><strong>Fixed Window</strong></td>
  <td>æŒ‰å›ºå®šæ—¶é—´çª—å£è®¡æ•°ï¼ˆå¦‚æ¯åˆ†é’Ÿ 100 æ¬¡ï¼‰</td>
  <td>å®ç°æœ€ç®€å•ï¼›å†…å­˜å°</td>
  <td>çª—å£è¾¹ç•Œçªå‘é—®é¢˜ï¼ˆ59 ç§’ 100 æ¬¡ + 61 ç§’ 100 æ¬¡ = 2 ç§’å†… 200 æ¬¡ï¼‰</td>
  <td>ç®€å•é™æµã€ä¸æ•æ„Ÿåœºæ™¯</td>
</tr>
<tr>
  <td><strong>Sliding Window Log</strong></td>
  <td>è®°å½•æ¯ä¸ªè¯·æ±‚æ—¶é—´æˆ³ï¼Œæ»‘åŠ¨è®¡ç®—çª—å£å†…è¯·æ±‚æ•°</td>
  <td>ç²¾ç¡®ï¼›æ— è¾¹ç•Œé—®é¢˜</td>
  <td>å†…å­˜å¤§ï¼ˆå­˜æ¯ä¸ªè¯·æ±‚ tsï¼‰ï¼›O(n) æ¸…ç†</td>
  <td>é«˜ç²¾åº¦ã€ä½æµé‡åœºæ™¯</td>
</tr>
<tr>
  <td><strong>Sliding Window Counter</strong></td>
  <td>åŠ æƒæ··åˆå½“å‰çª—å£å’Œä¸Šä¸€ä¸ªçª—å£çš„è®¡æ•°</td>
  <td>å†…å­˜å°ï¼›è¿‘ä¼¼ç²¾ç¡®</td>
  <td>åªæ˜¯è¿‘ä¼¼å€¼</td>
  <td>å®é™…æœ€å¸¸ç”¨çš„ Fixed Window æ”¹è¿›ç‰ˆ</td>
</tr>
<tr>
  <td><strong>Leaky Bucket</strong></td>
  <td>è¯·æ±‚è¿›é˜Ÿåˆ—ï¼ŒåŒ€é€Ÿæµå‡ºå¤„ç†</td>
  <td>è¾“å‡ºç»å¯¹å¹³æ»‘</td>
  <td>æ— æ³•å¤„ç†çªå‘ï¼›é˜Ÿåˆ—æ»¡åˆ™ä¸¢å¼ƒ</td>
  <td>ç½‘ç»œæµé‡æ•´å½¢ï¼ˆtraffic shapingï¼‰</td>
</tr>
<tr>
  <td style="color: var(--green);"><strong>Token Bucket âœ…</strong></td>
  <td>åŒ€é€Ÿè¡¥å……ä»£å¸ï¼Œæœ‰ä»£å¸å°±æ”¾è¡Œ</td>
  <td>å…è®¸çªå‘ï¼›å®ç°ç®€å•ï¼›å‚æ•°ç›´è§‚</td>
  <td>åˆ†å¸ƒå¼ä¸€è‡´æ€§éœ€é¢å¤–è®¾è®¡</td>
  <td>API é™æµã€ç½‘ç»œ QoSã€è®¢é˜…è®¡é‡</td>
</tr>
</table>

<h3>Leaky Bucket vs Token Bucket â€” æœ€å®¹æ˜“æ··æ·†çš„ä¸€å¯¹</h3>
<div class="card warn">
<p>ä¸€å¥è¯åŒºåˆ†ï¼š</p>
<ul>
  <li><strong>Leaky Bucket</strong> = æ°´ï¼ˆè¯·æ±‚ï¼‰è¿›æ¡¶ï¼ŒåŒ€é€Ÿæ¼å‡º â†’ <strong>æ§åˆ¶è¾“å‡ºé€Ÿç‡</strong>ï¼ˆå¹³æ»‘ï¼‰</li>
  <li><strong>Token Bucket</strong> = ä»£å¸åŒ€é€Ÿè¿›æ¡¶ï¼Œè¯·æ±‚æ¶ˆè€—ä»£å¸ â†’ <strong>æ§åˆ¶è¾“å…¥é€Ÿç‡</strong>ï¼ˆå…è®¸çªå‘ï¼‰</li>
</ul>
<p style="margin-top: 0.5rem;">Leaky Bucket åƒä¸€ä¸ª<strong>ä¸¥æ ¼çš„èŠ‚æ‹å™¨</strong>ğŸµâ€”â€”ä¸ç®¡ä½ å¤šæ€¥ï¼Œæ¯ç§’åªå¤„ç†å›ºå®šæ•°é‡ã€‚<br>
Token Bucket åƒä¸€ä¸ª<strong>æ”’é›¶èŠ±é’±</strong>ğŸ’°â€”â€”æ”’å¤Ÿäº†å¯ä»¥ä¸€å£æ°”èŠ±æ‰ï¼Œä½†é•¿æœŸæ¥çœ‹èŠ±é’±é€Ÿåº¦æ˜¯æ’å®šçš„ã€‚</p>
</div>

<!-- ==================== SECTION 3 ==================== -->
<h2>ä¸‰ã€ä¸ºä»€ä¹ˆ Token Bucket æ˜¯å·¥ä¸šç•Œé¦–é€‰ï¼Ÿ</h2>

<div class="card">
<ol>
  <li><strong>å¯¹ç”¨æˆ·å‹å¥½</strong>ï¼šå…è®¸ burstã€‚ç”¨æˆ·å¶å°”çš„è¯·æ±‚é«˜å³°ä¸ä¼šè¢«ç²—æš´æ‹’ç»ï¼Œä½“éªŒæ›´å¥½ã€‚</li>
  <li><strong>å‚æ•°è¯­ä¹‰æ¸…æ™°</strong>ï¼šrate = é•¿æœŸå¹³å‡é€Ÿç‡ï¼Œburst = çŸ­æœŸå³°å€¼å®¹å¿åº¦ã€‚äº§å“ç»ç†éƒ½èƒ½ç†è§£ã€‚</li>
  <li><strong>å®ç°æç®€</strong>ï¼šåªéœ€ 2 ä¸ªæ•°å­—ï¼ˆtokens + timestampï¼‰ï¼Œæ— éœ€å­˜è¯·æ±‚æ—¥å¿—ï¼ŒO(1) æ—¶é—´å’Œç©ºé—´ã€‚</li>
  <li><strong>çµæ´»æ€§å¼º</strong>ï¼š
    <ul>
      <li>ä¸åŒè¯·æ±‚æ¶ˆè€—ä¸åŒæ•°é‡çš„ tokenï¼ˆå¦‚ GPT-4 æ¶ˆè€— 10x GPT-3.5ï¼‰</li>
      <li>å¤šå±‚åµŒå¥—ï¼ˆper-user + per-IP + globalï¼‰</li>
      <li>åŠ¨æ€è°ƒæ•´ rate å’Œ burst</li>
    </ul>
  </li>
  <li><strong>ç½‘ç»œåè®®åŸç”Ÿæ”¯æŒ</strong>ï¼šLinux å†…æ ¸çš„ <span class="inline-code">tc</span>ï¼ˆtraffic controlï¼‰ç›´æ¥ç”¨ Token Bucket Filterï¼ˆTBFï¼‰</li>
</ol>
</div>

<!-- ==================== SECTION 4 ==================== -->
<h2>å››ã€å®é™…åº”ç”¨åœºæ™¯ ğŸŒ</h2>

<h3>1. API Rate Limitingï¼ˆæœ€å¸¸è§ï¼‰</h3>
<div class="card">
<p><strong>Stripe</strong>: 100 requests/sec per API key, burst up to 200</p>
<p><strong>GitHub API</strong>: 5000 requests/hour (token bucket with hourly refill)</p>
<p><strong>OpenAI</strong>: TPM (tokens per minute) + RPM (requests per minute) åŒé‡ token bucket</p>
<pre><code>X-RateLimit-Limit: 100
X-RateLimit-Remaining: 42     â† æ¡¶é‡Œå‰©ä½™ä»£å¸
X-RateLimit-Reset: 1708300800 â† ä¸‹æ¬¡è¡¥å……æ—¶é—´
Retry-After: 30               â† 429 æ—¶å‘Šè¯‰å®¢æˆ·ç«¯ç­‰å¤šä¹…</code></pre>
</div>

<h3>2. Claude Max Subscription</h3>
<div class="card highlight">
<p>Anthropic çš„ Claude Max ($100/mo) ä½¿ç”¨<strong>æ»šåŠ¨çª—å£ Token Bucket</strong>å˜ä½“ï¼š</p>
<ul>
  <li>Window: 5 hours (rolling)</li>
  <li>Bucket: N messages (å…·ä½“æ•°å­—æœªå…¬å¼€ï¼Œæ ¹æ®æ¨¡å‹ä¸åŒ)</li>
  <li>Refill: æ¶ˆæ¯é¢åº¦åœ¨ 5h çª—å£å†…æ¸è¿›æ¢å¤</li>
  <li>ä¸åŒæ¨¡å‹æ¶ˆè€—ä¸åŒ token æ•°ï¼šOpus >> Sonnet >> Haiku</li>
</ul>
<p style="margin-top: 0.5rem;">è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ ç”¨ Opus å‡ æ¡æ¶ˆæ¯å°±è§¦å‘é™åˆ¶ï¼Œè€Œ Haiku å¯ä»¥èŠå¾ˆä¹…â€”â€”ä¸åŒæ¨¡å‹çš„"æ¶ˆè€—æˆæœ¬"ä¸åŒï¼Œä½†å…±äº«åŒä¸€ä¸ªæ¡¶ã€‚</p>
</div>

<h3>3. ç½‘ç»œ QoSï¼ˆQuality of Serviceï¼‰</h3>
<div class="card">
<p>Linux å†…æ ¸çš„ <span class="inline-code">tc tbf</span> ç›´æ¥å®ç° Token Bucket Filterï¼š</p>
<pre><code># é™åˆ¶ eth0 å‡ºå£å¸¦å®½ä¸º 1Mbit/sï¼Œburst 32KB
tc qdisc add dev eth0 root tbf rate 1mbit burst 32kbit latency 400ms</code></pre>
<p>AWS/GCP çš„ç½‘ç»œå¸¦å®½é™åˆ¶ã€Docker å®¹å™¨ç½‘ç»œé™æµï¼Œåº•å±‚éƒ½æ˜¯ TBFã€‚</p>
</div>

<h3>4. å…¶ä»–åœºæ™¯</h3>
<div class="card">
<ul>
  <li><strong>æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é€Ÿç‡</strong>ï¼šKafka consumer ç”¨ token bucket æ§åˆ¶æ¶ˆè´¹é€Ÿåº¦ï¼Œé¿å…å‹å®ä¸‹æ¸¸</li>
  <li><strong>ç™»å½•é˜²æš´åŠ›ç ´è§£</strong>ï¼šæ¯ä¸ª IP æ¯åˆ†é’Ÿæœ€å¤š 5 æ¬¡ç™»å½•å°è¯•</li>
  <li><strong>çŸ­ä¿¡/é‚®ä»¶å‘é€</strong>ï¼šé˜²æ­¢æ»¥ç”¨ï¼Œæ¯ç”¨æˆ·æ¯å¤©æœ€å¤š 10 æ¡éªŒè¯ç </li>
  <li><strong>å¾®æœåŠ¡ç†”æ–­</strong>ï¼šEnvoy/Istio çš„ rate limiting filter</li>
</ul>
</div>

<!-- ==================== SECTION 5 ==================== -->
<h2>äº”ã€ä»£ç å®ç° ğŸ’»</h2>

<h3>Python å®ç°ï¼ˆå•æœºç‰ˆï¼‰</h3>
<pre><code>import time
from threading import Lock

class TokenBucket:
    """Thread-safe Token Bucket rate limiter."""
    
    def __init__(self, rate: float, capacity: int):
        """
        Args:
            rate: tokens added per second (refill rate)
            capacity: max tokens the bucket can hold (burst size)
        """
        self.rate = rate
        self.capacity = capacity
        self.tokens = capacity  # start full
        self.last_refill = time.monotonic()
        self.lock = Lock()
    
    def consume(self, tokens: int = 1) -> bool:
        """Try to consume tokens. Returns True if allowed."""
        with self.lock:
            now = time.monotonic()
            # Lazy refill: calculate tokens earned since last check
            elapsed = now - self.last_refill
            self.tokens = min(
                self.capacity,
                self.tokens + elapsed * self.rate
            )
            self.last_refill = now
            
            if self.tokens >= tokens:
                self.tokens -= tokens
                return True  # âœ… Allowed
            return False      # âŒ Rate limited
    
    def wait_time(self) -> float:
        """How long until 1 token is available."""
        if self.tokens >= 1:
            return 0.0
        return (1 - self.tokens) / self.rate

# Usage
limiter = TokenBucket(rate=10, capacity=100)  # 10 req/s, burst 100

for i in range(120):
    if limiter.consume():
        print(f"Request {i}: âœ… Allowed")
    else:
        wait = limiter.wait_time()
        print(f"Request {i}: âŒ Limited (retry in {wait:.2f}s)")</code></pre>

<h3>Redis å®ç°ï¼ˆåˆ†å¸ƒå¼ç‰ˆï¼‰</h3>
<pre><code>-- token_bucket.lua (Redis Lua script, atomic execution)
local key = KEYS[1]
local rate = tonumber(ARGV[1])       -- tokens per second
local capacity = tonumber(ARGV[2])   -- max bucket size
local now = tonumber(ARGV[3])        -- current timestamp (ms)
local requested = tonumber(ARGV[4])  -- tokens to consume

-- Get current state
local data = redis.call('HMGET', key, 'tokens', 'last_refill')
local tokens = tonumber(data[1]) or capacity
local last_refill = tonumber(data[2]) or now

-- Refill tokens
local elapsed = (now - last_refill) / 1000.0
tokens = math.min(capacity, tokens + elapsed * rate)

-- Try to consume
local allowed = 0
if tokens >= requested then
    tokens = tokens - requested
    allowed = 1
end

-- Save state (expire key after bucket-fill-time as safety)
redis.call('HMSET', key, 'tokens', tokens, 'last_refill', now)
redis.call('PEXPIRE', key, math.ceil(capacity / rate) * 2000)

return { allowed, math.floor(tokens * 100) / 100 }</code></pre>

<pre><code># Python wrapper
import redis, time

r = redis.Redis()
script = r.register_script(open('token_bucket.lua').read())

def is_allowed(user_id: str, rate=10, capacity=100, cost=1) -> bool:
    key = f"ratelimit:{user_id}"
    now_ms = int(time.time() * 1000)
    result = script(keys=[key], args=[rate, capacity, now_ms, cost])
    return bool(result[0])</code></pre>

<!-- ==================== SECTION 6 ==================== -->
<h2>å…­ã€é¢è¯•é¢˜ï¼šDesign a Distributed Rate Limiter ğŸ¯</h2>

<div class="card highlight">
<h3>é¢˜ç›®</h3>
<p>è®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼ rate limiterï¼Œæ”¯æŒå¤šæœºæˆ¿éƒ¨ç½²ï¼Œæ¯ä¸ª API key é™åˆ¶ 1000 req/minã€‚</p>
</div>

<h3>Step 1: éœ€æ±‚åˆ†æ</h3>
<div class="card">
<ul>
  <li><strong>åŠŸèƒ½éœ€æ±‚</strong>ï¼šæŒ‰ API key é™æµï¼›è¿”å›å‰©ä½™é¢åº¦å’Œé‡ç½®æ—¶é—´ï¼›æ”¯æŒä¸åŒ tier</li>
  <li><strong>éåŠŸèƒ½éœ€æ±‚</strong>ï¼šä½å»¶è¿Ÿï¼ˆ<1ms overheadï¼‰ï¼›é«˜å¯ç”¨ï¼›æœ€ç»ˆä¸€è‡´å³å¯ï¼ˆå®å¯å¶å°”å¤šæ”¾å‡ ä¸ªè¯·æ±‚ï¼Œä¸èƒ½è¯¯æ€ï¼‰</li>
  <li><strong>è§„æ¨¡</strong>ï¼š100M DAUï¼Œpeak 1M QPS</li>
</ul>
</div>

<h3>Step 2: é«˜å±‚è®¾è®¡</h3>
<div class="card">
<div class="diagram">
Client â†’ API Gateway â†’ Rate Limiter Middleware â†’ Backend Service
                              â”‚
                              â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  Redis Cluster   â”‚  â† Token Bucket state
                     â”‚  (per API key)   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  Rules Config    â”‚  â† Rate limit rules per tier
                     â”‚  (DB / Config)   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</div>
</div>

<h3>Step 3: æ ¸å¿ƒè®¾è®¡å†³ç­–</h3>

<div class="card">
<h4>ğŸ”¹ ä¸ºä»€ä¹ˆé€‰ Token Bucketï¼Ÿ</h4>
<p>å…è®¸ burst å¯¹ API ç”¨æˆ·æ›´å‹å¥½ï¼›ä¸¤ä¸ªå‚æ•°ï¼ˆrate, burstï¼‰ç›´æ¥æ˜ å°„ä¸ºäº§å“éœ€æ±‚ã€‚</p>

<h4>ğŸ”¹ ä¸ºä»€ä¹ˆç”¨ Redisï¼Ÿ</h4>
<ul>
  <li>å•çº¿ç¨‹ â†’ å¤©ç„¶åŸå­æ“ä½œï¼ˆLua script ä¿è¯åŸå­æ€§ï¼‰</li>
  <li>å†…å­˜æ•°æ®åº“ â†’ ä½å»¶è¿Ÿ</li>
  <li>Cluster æ¨¡å¼ â†’ æ°´å¹³æ‰©å±•ï¼ˆæŒ‰ key hash åˆ†ç‰‡ï¼‰</li>
</ul>

<h4>ğŸ”¹ å¤šæœºæˆ¿åŒæ­¥ç­–ç•¥</h4>
<table>
<tr><th>æ–¹æ¡ˆ</th><th>ä¸€è‡´æ€§</th><th>å»¶è¿Ÿ</th><th>é€‚ç”¨</th></tr>
<tr><td>ä¸­å¿ƒåŒ– Redis</td><td>å¼º</td><td>é«˜ï¼ˆè·¨æœºæˆ¿ RTTï¼‰</td><td>ä¸¥æ ¼é™æµ</td></tr>
<tr><td>æœ¬åœ° Redis + å¼‚æ­¥åŒæ­¥</td><td>æœ€ç»ˆä¸€è‡´</td><td>ä½</td><td>å¤§å¤šæ•°åœºæ™¯ âœ…</td></tr>
<tr><td>æœ¬åœ°è®¡æ•° + å®šæœŸæ±‡æ€»</td><td>å¼±</td><td>æœ€ä½</td><td>å®¹å¿åº¦é«˜çš„åœºæ™¯</td></tr>
</table>
<p style="margin-top: 0.5rem;"><strong>æ¨èæ–¹æ¡ˆ</strong>ï¼šæ¯ä¸ªæœºæˆ¿æœ‰æœ¬åœ° Redisï¼ŒæŒ‰æ¯”ä¾‹åˆ†é…é¢åº¦ï¼ˆå¦‚ 3 ä¸ªæœºæˆ¿å„åˆ† 333 req/minï¼‰ï¼Œå®šæœŸåŒæ­¥è°ƒæ•´ã€‚ç‰ºç‰²å°‘é‡ç²¾åº¦æ¢å–ä½å»¶è¿Ÿå’Œé«˜å¯ç”¨ã€‚</p>
</div>

<h3>Step 4: å®¹é”™è®¾è®¡</h3>
<div class="card">
<ul>
  <li><strong>Redis æŒ‚äº†æ€ä¹ˆåŠï¼Ÿ</strong> â†’ Fail-openï¼ˆæ”¾è¡Œï¼‰ã€‚Rate limiting æ˜¯ä¿æŠ¤æªæ–½ï¼Œä¸åº”æˆä¸ºå•ç‚¹æ•…éšœã€‚å¯é™çº§ä¸ºæœ¬åœ°å†…å­˜ Token Bucketã€‚</li>
  <li><strong>æ—¶é’Ÿä¸åŒæ­¥ï¼Ÿ</strong> â†’ ç”¨ Redis æœåŠ¡ç«¯æ—¶é—´ï¼ˆ<span class="inline-code">redis.call('TIME')</span>ï¼‰ï¼Œä¸ä¾èµ–å®¢æˆ·ç«¯æ—¶é’Ÿã€‚</li>
  <li><strong>Race conditionï¼Ÿ</strong> â†’ Redis Lua è„šæœ¬åŸå­æ‰§è¡Œï¼Œæ— éœ€åˆ†å¸ƒå¼é”ã€‚</li>
  <li><strong>çƒ­ç‚¹ keyï¼ˆå¤§å®¢æˆ·ï¼‰ï¼Ÿ</strong> â†’ æœ¬åœ°ç¼“å­˜ + å®šæœŸåŒæ­¥ Redisï¼Œå‡å°‘å¯¹å•ä¸ª Redis node çš„å‹åŠ›ã€‚</li>
</ul>
</div>

<h3>Step 5: HTTP å“åº”è®¾è®¡</h3>
<pre><code>// æ­£å¸¸å“åº”ï¼Œæºå¸¦é™æµå¤´
HTTP/1.1 200 OK
X-RateLimit-Limit: 1000          // æ€»é¢åº¦
X-RateLimit-Remaining: 742       // å‰©ä½™
X-RateLimit-Reset: 1708300860    // é‡ç½®æ—¶é—´ (Unix epoch)

// è¢«é™æµ
HTTP/1.1 429 Too Many Requests
Retry-After: 17                  // å»ºè®®ç­‰å¾…ç§’æ•°
X-RateLimit-Limit: 1000
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1708300860
Content-Type: application/json

{"error": "rate_limit_exceeded", "message": "Too many requests"}</code></pre>

<div class="thought-box">
<h4>ğŸ¤” é¢è¯•åŠ åˆ†ç‚¹</h4>
<ul>
  <li><strong>å¤šç»´åº¦é™æµ</strong>ï¼šper-user, per-IP, per-endpoint, global å››å±‚åµŒå¥—ï¼Œå–æœ€ä¸¥æ ¼çš„</li>
  <li><strong>åŠ¨æ€è°ƒæ•´</strong>ï¼šæ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€é™ä½ rateï¼ˆè‡ªé€‚åº”é™æµ / adaptive throttlingï¼‰</li>
  <li><strong>å®¢æˆ·ç«¯é…åˆ</strong>ï¼šSDK å†…ç½® exponential backoff + jitterï¼Œå°Šé‡ Retry-After header</li>
  <li><strong>å¯è§‚æµ‹æ€§</strong>ï¼šPrometheus metricsï¼ˆrate_limited_total, bucket_tokens histogramï¼‰ï¼ŒGrafana dashboard</li>
  <li><strong>å…¬å¹³æ€§</strong>ï¼šä½¿ç”¨ Weighted Token Bucketï¼Œä¸åŒ tier çš„å®¢æˆ·æœ‰ä¸åŒçš„ rate å’Œ burst</li>
</ul>
</div>

<!-- ==================== SECTION 7 ==================== -->
<h2>ä¸ƒã€çŸ¥è¯†å›¾è°±è¿æ¥ ğŸ•¸ï¸</h2>

<div class="card">
<p>Token Bucket å’Œä¹‹å‰å­¦è¿‡çš„å†…å®¹çš„å…³ç³»ï¼š</p>
<ul>
  <li><strong>Design ChatGPT</strong>ï¼ˆDay 1ï¼‰â†’ API Gateway å±‚çš„ rate limiting å°±ç”¨ Token Bucket</li>
  <li><strong>Design Recommendation System</strong>ï¼ˆDay 2ï¼‰â†’ æ¨è API çš„æµé‡æ§åˆ¶</li>
  <li><strong>RAG System</strong>ï¼ˆPhase 1.3ï¼‰â†’ Embedding API è°ƒç”¨é¢‘ç‡æ§åˆ¶ï¼Œé¿å…è¢« OpenAI é™æµ</li>
  <li><strong>åˆ†å¸ƒå¼ç³»ç»Ÿ</strong> â†’ Rate Limiter æ˜¯å¾®æœåŠ¡æ¶æ„çš„åŸºç¡€ç»„ä»¶ï¼Œå’Œ Circuit Breakerã€Bulkhead å…±åŒæ„æˆå¼¹æ€§è®¾è®¡ä¸‰æ¿æ–§</li>
</ul>
</div>

<!-- ==================== SUMMARY ==================== -->
<h2>å…«ã€ä¸€é¡µæ€»ç»“ ğŸ“‹</h2>

<div class="card success">
<table>
<tr><th>æ¦‚å¿µ</th><th>è¦è®°ä½çš„</th></tr>
<tr><td>Token Bucket åŸç†</td><td>åŒ€é€Ÿè¡¥å……ä»£å¸ï¼Œè¯·æ±‚æ¶ˆè€—ä»£å¸ã€‚<strong>ä¸¤ä¸ªå‚æ•°</strong>ï¼šrateï¼ˆé•¿æœŸé€Ÿç‡ï¼‰+ burstï¼ˆçŸ­æœŸå³°å€¼ï¼‰</td></tr>
<tr><td>vs Leaky Bucket</td><td>Token Bucket å…è®¸ burstï¼ˆæ§åˆ¶è¾“å…¥ï¼‰ï¼ŒLeaky Bucket ç»å¯¹å¹³æ»‘ï¼ˆæ§åˆ¶è¾“å‡ºï¼‰</td></tr>
<tr><td>å®ç°æ ¸å¿ƒ</td><td>Lazy refillï¼šä¸éœ€è¦å®šæ—¶å™¨ï¼Œè¯·æ±‚æ¥äº†æ‰ç®—è¡¥äº†å¤šå°‘ã€‚O(1) æ—¶é—´/ç©ºé—´</td></tr>
<tr><td>åˆ†å¸ƒå¼æ–¹æ¡ˆ</td><td>Redis Lua script ä¿è¯åŸå­æ€§ + æœ¬åœ°ç¼“å­˜å‡å°‘è·¨ç½‘ç»œè°ƒç”¨</td></tr>
<tr><td>å®¹é”™åŸåˆ™</td><td>Fail-openï¼ˆRedis æŒ‚äº†å°±æ”¾è¡Œï¼‰ï¼Œrate limiting ä¸èƒ½æˆä¸ºç³»ç»Ÿå•ç‚¹æ•…éšœ</td></tr>
<tr><td>Claude Max</td><td>5h rolling window Token Bucket å˜ä½“ï¼Œä¸åŒæ¨¡å‹æ¶ˆè€—ä¸åŒ token æ•°</td></tr>
</table>
</div>

<div class="thought-box">
<h4>ğŸ’­ æ€è€ƒé¢˜ / Think About It</h4>
<p>å¦‚æœä½ åœ¨è®¾è®¡ä¸€ä¸ª AI API å¹³å°ï¼ˆç±»ä¼¼ OpenAIï¼‰ï¼Œä½ ä¼šæ€ä¹ˆè®¾è®¡ rate limiting çš„å®šä»·æ¨¡å‹ï¼Ÿ</p>
<ul>
  <li>æŒ‰è¯·æ±‚æ•°ï¼ˆRPMï¼‰è¿˜æ˜¯æŒ‰ token æ•°ï¼ˆTPMï¼‰è®¡è´¹æ›´åˆç†ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</li>
  <li>å¦‚ä½•è®©å…è´¹ç”¨æˆ·å’Œä»˜è´¹ç”¨æˆ·å…±äº«åŒä¸€å¥—ç³»ç»Ÿï¼ŒåŒæ—¶ä¿è¯ä»˜è´¹ç”¨æˆ·ä¸è¢«å…è´¹ç”¨æˆ·çš„æµé‡å½±å“ï¼Ÿ</li>
  <li>Hint: æƒ³æƒ³ <strong>Weighted Token Bucket</strong> + <strong>Priority Queue</strong> çš„ç»„åˆã€‚</li>
</ul>
</div>

<hr style="border-color: var(--border); margin: 2rem 0;">
<p style="color: var(--muted); font-size: 0.85rem;">
  ğŸ“š Knowledge Push Â· AI/Tech Series Â· Rate Limiting Special<br>
  Next up: Day 5 â€” Design AI Code Review System
</p>

</body>
</html>